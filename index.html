<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentic Story Accelerator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-error: var(--color-red-500);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: var(--color-gray-300);
                --color-border: rgba(119, 124, 124, 0.3);
            }
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 14px;
            line-height: 1.6;
            color: var(--color-text);
            background-color: var(--color-background);
            padding: 24px;
        }

        .container { max-width: 800px; margin: 0 auto; }

        header {
            text-align: center;
            margin-bottom: 32px;
        }

        h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 24px;
        }

        .progress-bar {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 24px;
        }

        .progress-step {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--color-surface);
            border: 2px solid var(--color-border);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: var(--color-text-secondary);
            transition: all 0.3s ease;
        }

        .progress-step.active {
            background-color: var(--color-primary);
            border-color: var(--color-primary);
            color: white;
        }

        .progress-step.completed {
            background-color: var(--color-teal-700);
            border-color: var(--color-teal-700);
            color: white;
        }

        .phase {
            display: none;
            background-color: var(--color-surface);
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }

        .phase.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .phase-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .phase-description {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .required { color: var(--color-error); }

        input, select, textarea {
            width: 100%;
            min-height: 44px;
            padding: 12px;
            font-size: 14px;
            font-family: inherit;
            color: var(--color-text);
            background-color: var(--color-background);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1);
        }

        input.error, select.error, textarea.error {
            border-color: var(--color-error);
        }

        input[readonly], textarea[readonly] {
            background-color: var(--color-surface);
            cursor: not-allowed;
            opacity: 0.7;
        }

        .help-text {
            font-size: 12px;
            color: var(--color-text-secondary);
            font-style: italic;
            margin-top: 4px;
        }

        .note {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 4px;
            padding: 8px;
            background-color: rgba(33, 128, 141, 0.05);
            border-radius: 6px;
        }

        .error-message {
            color: var(--color-error);
            font-size: 12px;
            margin-top: 4px;
        }

        .btn-primary, .btn-secondary {
            min-height: 44px;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 500;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-primary-hover);
        }

        .btn-primary:disabled {
            background-color: var(--color-border);
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--color-primary);
            border: 1px solid var(--color-primary);
        }

        .btn-secondary:hover {
            background-color: rgba(33, 128, 141, 0.1);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            gap: 16px;
            margin-top: 32px;
        }

        .hidden { display: none !important; }

        #loadingSpinner {
            text-align: center;
            padding: 24px;
            color: var(--color-text-secondary);
        }

        .storyboard-table {
            width: 100%;
            border-collapse: collapse;
            margin: 24px 0;
            background-color: var(--color-surface);
            border-radius: 8px;
            overflow: hidden;
        }

        .storyboard-table th {
            background-color: var(--color-primary);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
        }

        .storyboard-table td {
            padding: 12px;
            border-bottom: 1px solid var(--color-border);
            vertical-align: top;
        }

        .storyboard-table tr:last-child td {
            border-bottom: none;
        }

        .storyboard-table tr:nth-child(even) {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .action-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }

        @media (max-width: 768px) {
            body { padding: 16px; }
            .phase { padding: 24px; }
            .navigation { flex-direction: column; }
            .navigation button { width: 100%; }
            .storyboard-table { font-size: 12px; }
            .storyboard-table th, .storyboard-table td { padding: 8px; }
            .action-buttons { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Authentic Story Accelerator</h1>
            <p class="subtitle">Generate Bourdain-Style Storyboards for Your Business in Under 5 Minutes</p>
            <div class="progress-bar">
                <div class="progress-step active" data-phase="1">1</div>
                <div class="progress-step" data-phase="2">2</div>
                <div class="progress-step" data-phase="3">3</div>
                <div class="progress-step" data-phase="4">4</div>
            </div>
        </header>

        <!-- Phase 1: Business Setup -->
        <div id="phase1" class="phase active">
            <h2 class="phase-title">Phase 1: Business Setup</h2>
            <p class="phase-description">Define your business type and reel objectives with Bourdain-style authenticity</p>
            
            <div class="form-group">
                <label>Business/Service Type <span class="required">*</span></label>
                <select id="businessType" required>
                    <option value="">Select your business type...</option>
                    <option value="food">Food & Beverage (Restaurant, Bar, Caf√©)</option>
                    <option value="fitness">Wellness/Fitness (Gym, Yoga, Personal Training)</option>
                    <option value="travel">Travel/Adventure (Tours, Hotels, Experiences)</option>
                    <option value="retail">Retail/Products (Boutique, E-commerce)</option>
                    <option value="services">Professional Services (Consulting, Coaching)</option>
                    <option value="creative">Creative/Entertainment (Art Studio, Events)</option>
                </select>
                <p class="help-text">This anchors your reel's theme - transforms generic promo into a "Bourdain dispatch"</p>
            </div>

            <div class="form-group">
                <label>Reel Objective (Message Type) <span class="required">*</span></label>
                <select id="reelObjective" required>
                    <option value="">Select your objective...</option>
                    <option value="awareness">Awareness/Brand Intro ("Discover the soul")</option>
                    <option value="promotion">Promotion/Sale ("Taste the deal before it's gone")</option>
                    <option value="booking">Booking/Engagement ("Join the ritual tonight")</option>
                    <option value="testimonial">Testimonial/Story ("One bite changed everything")</option>
                    <option value="educational">Educational/Behind-the-Scenes ("The grind you don't see")</option>
                </select>
                <p class="help-text">Defines your call-to-action and emotional arc</p>
            </div>

            <div class="form-group">
                <label>Target Audience Profile <span class="required">*</span></label>
                <select id="targetAudience" required>
                    <option value="">Select your audience...</option>
                    <option value="rebels">18-24: Rebels (High-energy, bold, unfiltered)</option>
                    <option value="hustlers">25-40: Urban Hustlers (Busy, seeking authentic escapes)</option>
                    <option value="seekers">41+: Seasoned Seekers (Refined, nostalgic, quality-focused)</option>
                </select>
                <p class="help-text">Tailors language and pacing to resonate with your audience</p>
            </div>

            <div class="form-group">
                <label>Tone Intensity (Bourdain Flavor) <span class="required">*</span></label>
                <select id="toneIntensity" required>
                    <option value="">Select tone...</option>
                    <option value="cynical">Cynical & Witty (Dry humor, street-smart digs)</option>
                    <option value="poetic">Introspective & Poetic (Deep musings, sensory metaphors)</option>
                    <option value="bold">Adventurous & Bold (High-energy rants, dare-you challenges)</option>
                    <option value="warm">Nostalgic & Warm (Subtle sentiment under sarcasm)</option>
                </select>
                <p class="help-text">Adjusts VO phrasing and shot rhythm to match your brand</p>
            </div>

            <div class="form-group">
                <label>Reel Length <span class="required">*</span></label>
                <select id="reelLength" required>
                    <option value="">Select duration...</option>
                    <option value="15">15 seconds (Teaser - 3 scenes)</option>
                    <option value="30">30 seconds (Standard - 4 scenes)</option>
                    <option value="60">60 seconds (Deep Dive - 5 scenes)</option>
                </select>
                <p class="help-text">Determines scene count and pacing</p>
            </div>

            <div class="form-group">
                <label>Hero Product/Service <span class="required">*</span></label>
                <input type="text" id="heroProduct" placeholder="e.g., Kufta Kebab dinner specials, HIIT workout class" required>
                <p class="help-text">The star of your reel - what gets the macro reveal</p>
            </div>

            <div class="form-group">
                <label>Location/Setting <span class="required">*</span></label>
                <select id="locationSetting" required>
                    <option value="">Select setting...</option>
                    <option value="indoor">Indoor (Studio, Kitchen, Interior)</option>
                    <option value="outdoor">Outdoor (Street, Urban, Nature)</option>
                    <option value="hybrid">Hybrid (Mix of both)</option>
                </select>
                <p class="help-text">Defines visual environment and lighting style</p>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="loadExample()">Load Example</button>
                <button class="btn-primary" id="nextBtn1" onclick="nextPhase()">Next</button>
            </div>
        </div>

        <!-- Phase 2: Business Details -->
        <div id="phase2" class="phase">
            <h2 class="phase-title">Phase 2: Business Details</h2>
            <p class="phase-description">Provide specific details for AI-powered story generation</p>
            
            <div class="form-group">
                <label>Business Name <span class="required">*</span></label>
                <input type="text" id="businessName" placeholder="Your business name" required>
            </div>

            <div class="form-group">
                <label>Location <span class="required">*</span></label>
                <input type="text" id="location" placeholder="City, neighborhood, or address" required>
                <p class="help-text">Be specific - helps AI create authentic local flavor</p>
            </div>

            <div class="form-group">
                <label>Website</label>
                <input type="url" id="website" placeholder="https://yourwebsite.com">
            </div>

            <div class="form-group">
                <label>Unique Value Proposition <span class="required">*</span></label>
                <textarea id="uniqueValue" rows="4" placeholder="What makes you different? What's your secret sauce?" required></textarea>
                <p class="help-text">This is the heart of your story - be specific and authentic</p>
            </div>

            <div class="form-group">
                <label>Current Specials/Offers</label>
                <textarea id="specials" rows="3" placeholder="Any promotions, seasonal items, or limited-time offers?"></textarea>
            </div>

            <div class="form-group">
                <label>Perplexity API Key <span class="required">*</span></label>
                <input type="password" id="apiKey" placeholder="pplx-xxxxxxxxxxxxx" required>
                <p class="help-text">Get your API key from <a href="https://www.perplexity.ai/settings/api" target="_blank" rel="noopener noreferrer">https://www.perplexity.ai/settings/api</a></p>
                <p class="note">üîí Your API key is stored only in your browser session, never saved</p>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="previousPhase()">Previous</button>
                <button class="btn-primary" id="nextBtn2" onclick="nextPhase()">Next</button>
            </div>
        </div>

        <!-- Phase 3: AI Story Generation -->
        <div id="phase3" class="phase">
            <h2 class="phase-title">Phase 3: AI Story Generation</h2>
            <p class="phase-description">Generate your Bourdain-style narrative with AI</p>
            
            <button class="btn-primary" id="generateBtn" onclick="generateStoryWithAI()" style="width: 100%; margin-bottom: 24px;">Generate Story with AI</button>
            
            <div id="loadingSpinner" class="hidden">
                <p style="font-size: 16px; margin-bottom: 12px;">üé¨ Generating your story...</p>
                <div id="statusMessages" style="font-size: 13px; color: var(--color-text-secondary); line-height: 1.8;">
                    <p id="status1">‚è≥ Connecting to Perplexity AI...</p>
                    <p id="status2" class="hidden">‚úÖ Connected successfully</p>
                    <p id="status3" class="hidden">üß† Analyzing your business details...</p>
                    <p id="status4" class="hidden">‚úçÔ∏è Crafting Bourdain-style narrative...</p>
                    <p id="status5" class="hidden">üé≠ Generating scene-by-scene voiceover...</p>
                    <p id="status6" class="hidden">‚ö° Finalizing your story...</p>
                </div>
                <p style="font-size: 12px; margin-top: 16px; font-style: italic;">This typically takes 10-30 seconds. Complex requests may take up to 2 minutes.</p>
            </div>

            <div id="errorMessage" class="error-message hidden" style="padding: 12px; background-color: rgba(192, 21, 47, 0.1); border-radius: 8px; margin-top: 16px;"></div>
            
            <div id="generatedContent" class="hidden">
                <div class="form-group">
                    <label>Title Hook</label>
                    <input type="text" id="titleHook" readonly>
                </div>
                
                <div class="form-group">
                    <label>Pain Point/Message</label>
                    <textarea id="painPoint" rows="3" readonly></textarea>
                </div>
                
                <div class="form-group">
                    <label>Scene 1 Narrative VO</label>
                    <textarea id="scene1VO" rows="4" readonly></textarea>
                </div>
                
                <div class="form-group">
                    <label>Scene 2 Narrative VO</label>
                    <textarea id="scene2VO" rows="4" readonly></textarea>
                </div>
                
                <div class="form-group">
                    <label>Scene 3 Narrative VO</label>
                    <textarea id="scene3VO" rows="4" readonly></textarea>
                </div>
                
                <div class="form-group" id="scene4Group" style="display: none;">
                    <label>Scene 4 Narrative VO</label>
                    <textarea id="scene4VO" rows="4" readonly></textarea>
                </div>
                
                <div class="form-group" id="scene5Group" style="display: none;">
                    <label>Scene 5 Narrative VO</label>
                    <textarea id="scene5VO" rows="4" readonly></textarea>
                </div>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="previousPhase()">Previous</button>
                <button class="btn-primary" id="nextBtn3" onclick="nextPhase()" disabled>Next</button>
            </div>
        </div>

        <!-- Phase 4: Final Storyboard -->
        <div id="phase4" class="phase">
            <h2 class="phase-title">Phase 4: Your Storyboard</h2>
            <p class="phase-description">Complete production-ready storyboard</p>
            
            <table class="storyboard-table" id="storyboardTable">
                <thead>
                    <tr>
                        <th>Scene #</th>
                        <th>Scene Name</th>
                        <th>Duration</th>
                        <th>Narrative VO</th>
                        <th>Visual Description</th>
                        <th>Shot List</th>
                    </tr>
                </thead>
                <tbody id="storyboardBody">
                </tbody>
            </table>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="editInputs()">Edit Inputs</button>
                <button class="btn-primary" onclick="exportPDF()">Export as PDF</button>
            </div>
        </div>
    </div>

    <script>
        let currentPhase = 1;
        let storyData = {};

        document.addEventListener('DOMContentLoaded', () => {
            initializeValidation();
            updateProgressBar();
        });

        function initializeValidation() {
            const phase1Fields = ['businessType', 'reelObjective', 'targetAudience', 'toneIntensity', 'reelLength', 'heroProduct', 'locationSetting'];
            const phase2Fields = ['businessName', 'location', 'uniqueValue', 'apiKey'];
            
            [...phase1Fields, ...phase2Fields].forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', () => {
                        clearError(element);
                        updateNextButtonState();
                    });
                    element.addEventListener('change', () => {
                        clearError(element);
                        updateNextButtonState();
                    });
                }
            });
        }

        function updateNextButtonState() {
            const isValid = validateCurrentPhase(false);
            const nextBtn = document.getElementById(`nextBtn${currentPhase}`);
            if (nextBtn) {
                nextBtn.disabled = !isValid;
            }
        }

        function validateCurrentPhase(showErrors = true) {
            if (!showErrors) clearAllErrors();
            
            if (currentPhase === 1) {
                const required = ['businessType', 'reelObjective', 'targetAudience', 'toneIntensity', 'reelLength', 'heroProduct', 'locationSetting'];
                return required.every(fieldId => {
                    const el = document.getElementById(fieldId);
                    const isValid = el && el.value && el.value.trim() !== '';
                    if (!isValid && showErrors) {
                        showError(el, 'This field is required');
                    }
                    return isValid;
                });
            }
            
            if (currentPhase === 2) {
                const required = ['businessName', 'location', 'uniqueValue', 'apiKey'];
                return required.every(fieldId => {
                    const el = document.getElementById(fieldId);
                    const isValid = el && el.value && el.value.trim() !== '';
                    if (!isValid && showErrors) {
                        showError(el, 'This field is required');
                    }
                    return isValid;
                });
            }
            
            if (currentPhase === 3) {
                const titleHook = document.getElementById('titleHook');
                const isValid = titleHook && titleHook.value && titleHook.value.trim() !== '';
                if (!isValid && showErrors) {
                    const errorMsg = document.getElementById('errorMessage');
                    if (errorMsg) {
                        errorMsg.textContent = '‚ö†Ô∏è Please generate the story first by clicking "Generate Story with AI"';
                        errorMsg.classList.remove('hidden');
                    }
                }
                return isValid;
            }
            
            return true;
        }

        function showError(element, message) {
            element.classList.add('error');
            const existingError = element.parentElement.querySelector('.error-message');
            if (existingError) existingError.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            element.parentElement.appendChild(errorDiv);
        }

        function clearError(element) {
            element.classList.remove('error');
            const errorMsg = element.parentElement.querySelector('.error-message');
            if (errorMsg) errorMsg.remove();
        }

        function clearAllErrors() {
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            document.querySelectorAll('.error-message').forEach(el => el.remove());
        }

        function nextPhase() {
            if (!validateCurrentPhase(true)) return;
            
            if (currentPhase < 4) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase++;
                document.getElementById(`phase${currentPhase}`).classList.add('active');
                updateProgressBar();
                window.scrollTo(0, 0);
                
                if (currentPhase === 4) {
                    generateStoryboard();
                }
                
                updateNextButtonState();
            }
        }

        function previousPhase() {
            if (currentPhase > 1) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase--;
                document.getElementById(`phase${currentPhase}`).classList.add('active');
                updateProgressBar();
                window.scrollTo(0, 0);
            }
        }

        function updateProgressBar() {
            document.querySelectorAll('.progress-step').forEach((step, index) => {
                const phaseNum = index + 1;
                step.classList.remove('active', 'completed');
                if (phaseNum === currentPhase) {
                    step.classList.add('active');
                } else if (phaseNum < currentPhase) {
                    step.classList.add('completed');
                }
            });
        }

        async function generateStoryWithAI() {
            const apiKey = document.getElementById('apiKey')?.value;
            if (!apiKey) {
                const errEl = document.getElementById('errorMessage');
                if (errEl) {
                    errEl.textContent = '‚ö†Ô∏è Please enter your Perplexity API key in Phase 2.';
                    errEl.classList.remove('hidden');
                }
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const errorMessage = document.getElementById('errorMessage');
            const generatedContent = document.getElementById('generatedContent');
            
            document.querySelectorAll('#statusMessages p').forEach(p => p.classList.add('hidden'));
            const status1 = document.getElementById('status1');
            if (status1) status1.classList.remove('hidden');
            
            const formData = {
                businessType: document.getElementById('businessType').options[document.getElementById('businessType').selectedIndex].text,
                reelObjective: document.getElementById('reelObjective').options[document.getElementById('reelObjective').selectedIndex].text,
                targetAudience: document.getElementById('targetAudience').options[document.getElementById('targetAudience').selectedIndex].text,
                toneIntensity: document.getElementById('toneIntensity').options[document.getElementById('toneIntensity').selectedIndex].text,
                reelLength: document.getElementById('reelLength').value,
                heroProduct: document.getElementById('heroProduct').value,
                locationSetting: document.getElementById('locationSetting').options[document.getElementById('locationSetting').selectedIndex].text,
                businessName: document.getElementById('businessName').value,
                location: document.getElementById('location').value,
                uniqueValue: document.getElementById('uniqueValue').value,
                specials: document.getElementById('specials').value || 'None'
            };
            
            const sceneCount = formData.reelLength === '15' ? 3 : formData.reelLength === '30' ? 4 : 5;
            
            document.getElementById('scene4Group').style.display = sceneCount >= 4 ? 'block' : 'none';
            document.getElementById('scene5Group').style.display = sceneCount >= 5 ? 'block' : 'none';
            
            if (generateBtn) {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
            }
            if (loadingSpinner) loadingSpinner.classList.remove('hidden');
            if (errorMessage) {
                errorMessage.classList.add('hidden');
                errorMessage.textContent = '';
            }
            if (generatedContent) generatedContent.classList.add('hidden');
            
            const statusTimeline = [
                { delay: 500, id: 'status2' },
                { delay: 1500, id: 'status3' },
                { delay: 3000, id: 'status4' },
                { delay: 5000, id: 'status5' },
                { delay: 8000, id: 'status6' }
            ];
            
            const timeouts = [];
            statusTimeline.forEach(({ delay, id }) => {
                const timeout = setTimeout(() => {
                    const statusEl = document.getElementById(id);
                    if (statusEl && statusEl.classList) {
                        statusEl.classList.remove('hidden');
                    }
                }, delay);
                timeouts.push(timeout);
            });
            
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 120000);
                
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    signal: controller.signal,
                    body: JSON.stringify({
                        model: 'sonar-pro',
                        messages: [
                            {
                                role: 'system',
                                content: 'You are an expert video storyboard writer specializing in Anthony Bourdain-style narrative. Create gritty, introspective, sensory-driven voiceover scripts with raw honesty, poetic cynicism, and confessional intimacy.'
                            },
                            {
                                role: 'user',
                                content: `Create a ${formData.reelLength}-second video storyboard for ${formData.businessName}, a ${formData.businessType} business in ${formData.location}.

Business Details:
- Hero Product/Service: ${formData.heroProduct}
- Unique Value: ${formData.uniqueValue}
- Current Specials: ${formData.specials}
- Target Audience: ${formData.targetAudience}
- Tone: ${formData.toneIntensity}
- Objective: ${formData.reelObjective}
- Setting: ${formData.locationSetting}

Generate exactly the following in this format:

TITLE HOOK: [A compelling 10-word-max title that works without sound]

PAIN POINT: [Core message - what problem this solves, what audience loses if they don't watch]

SCENE 1 VO: [50-80 words of Bourdain-style narrative - raw, sensory, confessional]

SCENE 2 VO: [50-80 words]

SCENE 3 VO: [50-80 words]

${sceneCount >= 4 ? 'SCENE 4 VO: [50-80 words]' : ''}

${sceneCount >= 5 ? 'SCENE 5 VO: [50-80 words]' : ''}

Use sensory language (steam, sweat, grit), cynical wit, and authentic voice. Make it feel like a late-night confession.`
                            }
                        ],
                        temperature: 0.7,
                        max_tokens: 1500
                    })
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    const errorBody = await response.text().catch(() => 'Unknown error');
                    throw new Error(`API Error: ${response.status} ${response.statusText}. ${errorBody}`);
                }
                
                const data = await response.json();
                const aiResponse = data.choices[0].message.content;
                
                const titleHook = aiResponse.match(/TITLE HOOK:\s*(.+)/)?.[1]?.trim() || '';
                const painPoint = aiResponse.match(/PAIN POINT:\s*(.+?)(?=SCENE|$)/s)?.[1]?.trim() || '';
                const scene1VO = aiResponse.match(/SCENE 1 VO:\s*(.+?)(?=SCENE 2|$)/s)?.[1]?.trim() || '';
                const scene2VO = aiResponse.match(/SCENE 2 VO:\s*(.+?)(?=SCENE 3|$)/s)?.[1]?.trim() || '';
                const scene3VO = aiResponse.match(/SCENE 3 VO:\s*(.+?)(?=SCENE 4|$)/s)?.[1]?.trim() || '';
                const scene4VO = aiResponse.match(/SCENE 4 VO:\s*(.+?)(?=SCENE 5|$)/s)?.[1]?.trim() || '';
                const scene5VO = aiResponse.match(/SCENE 5 VO:\s*(.+)/s)?.[1]?.trim() || '';
                
                document.getElementById('titleHook').value = titleHook;
                document.getElementById('painPoint').value = painPoint;
                document.getElementById('scene1VO').value = scene1VO;
                document.getElementById('scene2VO').value = scene2VO;
                document.getElementById('scene3VO').value = scene3VO;
                if (sceneCount >= 4) document.getElementById('scene4VO').value = scene4VO;
                if (sceneCount >= 5) document.getElementById('scene5VO').value = scene5VO;
                
                storyData = { titleHook, painPoint, scenes: [scene1VO, scene2VO, scene3VO, scene4VO, scene5VO].filter(s => s) };
                
                timeouts.forEach(t => clearTimeout(t));
                
                if (generatedContent) generatedContent.classList.remove('hidden');
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Story with AI';
                }
                
                updateNextButtonState();
                
            } catch (error) {
                console.error('Generation error:', error);
                
                timeouts.forEach(t => clearTimeout(t));
                
                let errorMsg = '‚ö†Ô∏è Generation Error: ';
                if (error.name === 'AbortError') {
                    errorMsg += 'Request timed out after 2 minutes. Please try again.';
                } else if (error.message.includes('401')) {
                    errorMsg += 'Invalid API key. Please check your key in Phase 2.';
                } else if (error.message.includes('429')) {
                    errorMsg += 'Rate limit exceeded. Please wait and try again.';
                } else if (error.message.includes('Failed to fetch')) {
                    errorMsg += 'Network error. Please check your connection.';
                } else {
                    errorMsg += error.message;
                }
                
                if (errorMessage) {
                    errorMessage.innerHTML = `<strong>Error:</strong> ${errorMsg}`;
                    errorMessage.classList.remove('hidden');
                }
                if (loadingSpinner) loadingSpinner.classList.add('hidden');
                if (generateBtn) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate Story with AI';
                }
            }
        }

        function generateStoryboard() {
            const tbody = document.getElementById('storyboardBody');
            tbody.innerHTML = '';
            
            const sceneCount = storyData.scenes.length;
            const baseDuration = document.getElementById('reelLength').value === '15' ? 5 : 
                               document.getElementById('reelLength').value === '30' ? 7.5 : 12;
            
            const sceneNames = ['The Opening', 'The Hook', 'The Heart', 'The Build', 'The Close'];
            const visualStyles = {
                'indoor': 'Intimate interior lighting, close quarters, controlled environment',
                'outdoor': 'Natural light, urban grit, street-level authenticity',
                'hybrid': 'Transitions between controlled and raw environments'
            };
            
            const settingKey = document.getElementById('locationSetting').value;
            
            storyData.scenes.forEach((scene, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><strong>${index + 1}</strong></td>
                    <td>${sceneNames[index]}</td>
                    <td>${Math.round(baseDuration)}s</td>
                    <td>${scene}</td>
                    <td>${visualStyles[settingKey] || visualStyles.indoor}</td>
                    <td>
                        ‚Ä¢ Wide Establishing Shot (${Math.round(baseDuration/3)}s): Set the scene<br>
                        ‚Ä¢ Medium Close-Up (${Math.round(baseDuration/3)}s): Capture emotion<br>
                        ‚Ä¢ Close-Up Detail (${Math.round(baseDuration/3)}s): Sensory reveal
                    </td>
                `;
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            const pageHeight = 297;
            const marginBottom = 20;
            const maxYPos = pageHeight - marginBottom;
            
            const titleHook = document.getElementById('titleHook').value;
            const businessName = document.getElementById('businessName').value;
            const painPoint = document.getElementById('painPoint').value;
            
            doc.setFontSize(20);
            doc.setFont('helvetica', 'bold');
            doc.text(titleHook || 'Video Storyboard', 20, 20);
            
            doc.setFontSize(12);
            doc.setFont('helvetica', 'normal');
            doc.text(`Business: ${businessName}`, 20, 30);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 20, 36);
            
            let yPos = 48;
            doc.setFontSize(11);
            doc.setFont('helvetica', 'italic');
            const painLines = doc.splitTextToSize(`Message: ${painPoint}`, 170);
            doc.text(painLines, 20, yPos);
            yPos += (painLines.length * 5) + 15;
            
            const sceneCount = storyData.scenes.length;
            const baseDuration = document.getElementById('reelLength').value === '15' ? 5 : 
                               document.getElementById('reelLength').value === '30' ? 7.5 : 12;
            const sceneNames = ['The Opening', 'The Hook', 'The Heart', 'The Build', 'The Close'];
            const settingKey = document.getElementById('locationSetting').value;
            const visualStyles = {
                'indoor': 'Intimate interior lighting, close quarters, controlled environment',
                'outdoor': 'Natural light, urban grit, street-level authenticity',
                'hybrid': 'Transitions between controlled and raw environments'
            };
            
            storyData.scenes.forEach((scene, index) => {
                const estimatedHeight = 45;
                
                if (yPos + estimatedHeight > maxYPos) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.setFont('helvetica', 'bold');
                doc.text(`Scene ${index + 1}: ${sceneNames[index]}`, 20, yPos);
                yPos += 7;
                
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Duration: ${Math.round(baseDuration)}s`, 20, yPos);
                yPos += 6;
                
                doc.setFont('helvetica', 'italic');
                const voLines = doc.splitTextToSize(`VO: ${scene}`, 170);
                doc.text(voLines, 20, yPos);
                yPos += (voLines.length * 5) + 5;
                
                doc.setFont('helvetica', 'normal');
                doc.text(`Visual: ${visualStyles[settingKey] || visualStyles.indoor}`, 20, yPos);
                yPos += 6;
                
                const shotText = `Shots: Wide Establishing (${Math.round(baseDuration/3)}s) ‚Üí Medium Close-Up (${Math.round(baseDuration/3)}s) ‚Üí Close-Up Detail (${Math.round(baseDuration/3)}s)`;
                const shotLines = doc.splitTextToSize(shotText, 170);
                doc.text(shotLines, 20, yPos);
                yPos += (shotLines.length * 5) + 12;
            });
            
            doc.addPage();
            doc.setFontSize(18);
            doc.setFont('helvetica', 'bold');
            doc.text('Shot Type Reference Guide', 20, 20);
            
            const shotTypes = [
                ['Extreme Wide Shot (EWS)', 'Captures a vast scene, environment far beyond subject'],
                ['Wide Shot (WS)', 'Full subject with significant surroundings'],
                ['Medium Shot (MS)', 'Subject from waist up, focusing on body language'],
                ['Close-Up (CU)', 'Tight on face or object, fills screen'],
                ['POV', 'What subject sees through their eyes'],
                ['Dutch Angle', 'Tilted camera for unstable feel'],
                ['High Angle', 'Looking down on subject'],
                ['Low Angle', 'Looking up at subject'],
                ['Tracking Shot', 'Camera follows subject smoothly'],
                ['Pan', 'Horizontal swivel from fixed position'],
                ['Tilt', 'Vertical pivot (up/down)'],
                ['Zoom', 'Lens magnification without camera movement']
            ];
            
            yPos = 35;
            doc.setFontSize(10);
            shotTypes.forEach(([type, desc]) => {
                if (yPos > 270) {
                    doc.addPage();
                    yPos = 20;
                }
                doc.setFont('helvetica', 'bold');
                doc.text(type, 20, yPos);
                yPos += 5;
                doc.setFont('helvetica', 'normal');
                const descLines = doc.splitTextToSize(desc, 170);
                doc.text(descLines, 20, yPos);
                yPos += (descLines.length * 5) + 5;
            });
            
            doc.save(`${businessName.replace(/\s+/g, '_')}_Storyboard.pdf`);
        }

        function editInputs() {
            const confirmed = window.confirm ? confirm('Are you sure you want to edit inputs? This will return you to Phase 1.') : true;
            if (confirmed) {
                document.getElementById(`phase${currentPhase}`).classList.remove('active');
                currentPhase = 1;
                document.getElementById('phase1').classList.add('active');
                updateProgressBar();
                window.scrollTo(0, 0);
            }
        }

        function loadExample() {
            document.getElementById('businessType').value = 'food';
            document.getElementById('reelObjective').value = 'booking';
            document.getElementById('targetAudience').value = 'hustlers';
            document.getElementById('toneIntensity').value = 'cynical';
            document.getElementById('reelLength').value = '60';
            document.getElementById('heroProduct').value = 'Midnight Ramen Tour';
            document.getElementById('locationSetting').value = 'outdoor';
            document.getElementById('businessName').value = 'Neon Noodles';
            document.getElementById('location').value = 'Shibuya, Tokyo';
            document.getElementById('uniqueValue').value = 'Late-night ramen tour in Tokyo\'s underbelly - authentic, unpolished adventures';
            document.getElementById('specials').value = 'Midnight tours starting at ¬•5000';
            updateNextButtonState();
        }
    </script>
</body>
</html>