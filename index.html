<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storyboard AI - Video Goal Router</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .container { max-width: 1000px; margin: 0 auto; }
    
    #goalScreen { display: grid; gap: 20px; }
    #goalScreen.hidden { display: none; }
    #wizardScreen.hidden { display: none; }
    
    .goal-header { background: white; padding: 40px; border-radius: 12px; text-align: center; margin-bottom: 20px; }
    .goal-header h1 { font-size: 32px; color: #333; margin-bottom: 10px; }
    .goal-header p { font-size: 16px; color: #666; }
    
    .goals-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; }
    .goal-card { background: white; border: 2px solid #e0e0e0; border-radius: 12px; padding: 25px; cursor: pointer; transition: all 0.3s ease; text-align: center; }
    .goal-card:hover { border-color: #667eea; box-shadow: 0 8px 16px rgba(102, 126, 234, 0.2); transform: translateY(-4px); }
    .goal-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%); }
    .goal-icon { font-size: 48px; margin-bottom: 15px; }
    .goal-title { font-size: 18px; font-weight: 600; color: #333; margin-bottom: 10px; }
    .goal-desc { font-size: 13px; color: #666; line-height: 1.5; margin-bottom: 12px; }
    .goal-specs { font-size: 12px; color: #999; background: #f5f5f5; padding: 10px; border-radius: 6px; }
    
    .goal-continue { text-align: center; margin-top: 30px; }
    .btn-continue { padding: 14px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; }
    .btn-continue:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-reset { padding: 14px 40px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; background: white; color: #667eea; border: 2px solid #667eea; margin-top: 15px; }
    .btn-reset:hover { background: #667eea; color: white; }
    
    #wizardScreen { display: grid; grid-template-columns: 1fr 280px; gap: 30px; }
    
    .api-section { grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; border: 2px solid #e0e0e0; display: flex; gap: 15px; align-items: flex-end; }
    .api-group { flex: 1; }
    .api-label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
    .api-input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
    .api-btn { padding: 12px 20px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; }
    
    .progress { grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; }
    .progress-bar { height: 4px; background: #e0e0e0; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; }
    
    .wizard-content { background: white; border-radius: 12px; padding: 40px; }
    .step { display: none; }
    .step.active { display: block; }
    .step.hidden { display: none !important; }
    
    .step h2 { font-size: 28px; color: #333; margin-bottom: 10px; }
    .step p { font-size: 15px; color: #666; margin-bottom: 30px; }
    
    .form-group { margin-bottom: 25px; }
    .form-label { display: block; font-weight: 600; color: #333; margin-bottom: 12px; font-size: 14px; }
    .form-input, .form-select, .form-textarea { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; }
    .form-textarea { resize: vertical; min-height: 80px; }
    
    .options-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .option-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; text-align: center; cursor: pointer; background: white; transition: all 0.3s; }
    .option-card:hover { border-color: #667eea; }
    .option-card.selected { border-color: #667eea; background: rgba(102, 126, 234, 0.08); }
    .option-icon { font-size: 24px; margin-bottom: 8px; }
    .option-name { font-weight: 600; color: #333; font-size: 13px; }
    
    .step-actions { display: flex; gap: 10px; margin-top: 30px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }
    .btn-secondary { background: #f0f0f0; color: #666; margin-right: auto; }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    
    .sidebar { background: white; border-radius: 12px; padding: 25px; height: fit-content; position: sticky; top: 20px; }
    .sidebar h3 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 13px; }
    .summary-label { font-weight: 600; color: #666; }
    .summary-value { color: #667eea; font-weight: 500; text-align: right; }
    
    @media (max-width: 1024px) {
      #wizardScreen { grid-template-columns: 1fr; }
      .sidebar { position: static; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="goalScreen">
      <div class="goal-header">
        <h1>üé¨ What's Your Video Goal?</h1>
        <p>Select the type of video you want to create. We'll customize the entire process for your goal.</p>
      </div>
      
      <div class="goals-grid">
        <div class="goal-card" onclick="selectGoal('awareness', this)">
          <div class="goal-icon">üìà</div>
          <div class="goal-title">Brand Awareness</div>
          <div class="goal-desc">Build recognition & emotional connection</div>
          <div class="goal-specs">30-60s ‚Ä¢ 70% B-Roll</div>
        </div>
        <div class="goal-card" onclick="selectGoal('launch', this)">
          <div class="goal-icon">üöÄ</div>
          <div class="goal-title">Product Launch</div>
          <div class="goal-desc">Introduce something new & drive clicks</div>
          <div class="goal-specs">15-30s ‚Ä¢ Problem-Solution</div>
        </div>
        <div class="goal-card" onclick="selectGoal('promo', this)">
          <div class="goal-icon">üî•</div>
          <div class="goal-title">Flash Sale/Promo</div>
          <div class="goal-desc">Create urgency & immediate sales</div>
          <div class="goal-specs">10-15s ‚Ä¢ Scarcity-Focused</div>
        </div>
        <div class="goal-card" onclick="selectGoal('team', this)">
          <div class="goal-icon">üë•</div>
          <div class="goal-title">Team Spotlight</div>
          <div class="goal-desc">Show culture & attract talent</div>
          <div class="goal-specs">20-45s ‚Ä¢ Personality-Driven</div>
        </div>
        <div class="goal-card" onclick="selectGoal('showcase', this)">
          <div class="goal-icon">‚ú®</div>
          <div class="goal-title">Business Showcase</div>
          <div class="goal-desc">General credibility & discovery</div>
          <div class="goal-specs">15-30s ‚Ä¢ Craft-Focused</div>
        </div>
      </div>
      
      <div class="goal-continue">
        <button class="btn-continue" onclick="continueToWizard()" id="continueBtn" disabled>Continue ‚Üí</button>
        <button class="btn-reset" onclick="startOver()">üîÑ Start Over</button>
      </div>
    </div>

    <div id="wizardScreen" class="hidden">
      <div style="grid-column: 1 / -1;">
        <div class="api-section">
          <div class="api-group" style="flex: 1;">
            <label class="api-label">üîë Perplexity API Key</label>
            <input type="password" id="apiInput" class="api-input" placeholder="pplx-xxxxxxxxxxxxxxxxxxxxxxxx">
            <div style="font-size: 11px; color: #999; margin-top: 6px;">Get from <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color: #667eea;">Perplexity Settings</a></div>
          </div>
          <button id="toggleApiBtn" class="api-btn" onclick="toggleApiVis()">üëÅÔ∏è Show</button>
        </div>
        
        <div class="progress">
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div style="text-align: center; font-size: 12px; color: #666; margin-top: 10px;">
            <span id="stepCounter">Step 1 of 7</span>
          </div>
        </div>
      </div>

      <div class="wizard-content">
        <!-- STEP 1: BUSINESS TYPE -->
        <div class="step active" data-step="1">
          <h2>What's Your Business Type?</h2>
          <p>This helps us tailor locations and activities</p>
          <div class="options-grid" id="businessGrid">
            <label class="option-card" onclick="selectBusiness('restaurant', this)">
              <div class="option-icon">üçΩÔ∏è</div>
              <div class="option-name">Restaurant</div>
            </label>
            <label class="option-card" onclick="selectBusiness('cafe', this)">
              <div class="option-icon">‚òï</div>
              <div class="option-name">Cafe</div>
            </label>
            <label class="option-card" onclick="selectBusiness('bar', this)">
              <div class="option-icon">üç∏</div>
              <div class="option-name">Bar</div>
            </label>
            <label class="option-card" onclick="selectBusiness('hotel', this)">
              <div class="option-icon">üè®</div>
              <div class="option-name">Hotel</div>
            </label>
            <label class="option-card" onclick="selectBusiness('wellness', this)">
              <div class="option-icon">üí™</div>
              <div class="option-name">Wellness</div>
            </label>
            <label class="option-card" onclick="selectBusiness('education', this)">
              <div class="option-icon">üìö</div>
              <div class="option-name">Education</div>
            </label>
          </div>
          <div class="step-actions">
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 2: CAMPAIGN OBJECTIVE (Dynamic per business) -->
        <div class="step hidden" data-step="2">
          <h2>What's Your Campaign Objective?</h2>
          <p>Select the focus for your video</p>
          <div class="options-grid" id="objectiveGrid"></div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 3: CAMPAIGN DETAILS (Conditional) -->
        <div class="step hidden" data-step="3" id="campaignDetailsStep">
          <h2 id="campaignDetailsTitle">Campaign Details</h2>
          <p id="campaignDetailsDesc"></p>
          <div id="campaignDetailsContent"></div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 4: WEBSITE & DEMOGRAPHICS -->
        <div class="step hidden" data-step="4">
          <h2>Business Context & Audience</h2>
          <p>Help us understand your business and target audience</p>
          <div class="form-group">
            <label class="form-label">Website URL (optional)</label>
            <input type="url" id="websiteUrl" class="form-input" placeholder="https://myrestaurant.com">
            <small style="color: #999; display: block; margin-top: 6px;">We'll auto-extract your USP and services</small>
          </div>
          <div class="form-group">
            <label class="form-label">Business Name</label>
            <input type="text" id="businessName" class="form-input" placeholder="e.g., Jerusalem Grill">
          </div>
          <div class="form-group">
            <label class="form-label">Unique Value Proposition</label>
            <input type="text" id="uvp" class="form-input" placeholder="e.g., 30 years of authentic flavor">
          </div>
          <div class="form-group">
            <label class="form-label">Target Audience Age Range</label>
            <select id="ageRange" class="form-select" onchange="updateAudienceSummary()">
              <option value="">Select...</option>
              <option value="Gen Z (13-25)">Gen Z (13-25)</option>
              <option value="Millennials (26-40)">Millennials (26-40)</option>
              <option value="Gen X (41-56)">Gen X (41-56)</option>
              <option value="Boomers (57+)">Boomers (57+)</option>
              <option value="Mixed">Mixed</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Gender Diversity</label>
            <select id="genderDiversity" class="form-select" onchange="updateAudienceSummary()">
              <option value="">Select...</option>
              <option value="All genders">All genders</option>
              <option value="Predominantly male">Predominantly male</option>
              <option value="Predominantly female">Predominantly female</option>
              <option value="Mixed">Mixed</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Primary Setting/Context</label>
            <select id="primarySetting" class="form-select" onchange="updateAudienceSummary()">
              <option value="">Select...</option>
              <option value="Home office/Remote">Home office/Remote</option>
              <option value="Retail/In-store">Retail/In-store</option>
              <option value="Restaurant/Food">Restaurant/Food</option>
              <option value="Classroom/Education">Classroom/Education</option>
              <option value="Gym/Wellness">Gym/Wellness</option>
              <option value="Outdoor">Outdoor</option>
              <option value="Mixed">Mixed</option>
            </select>
          </div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 5: LOCATIONS -->
        <div class="step hidden" data-step="5" id="locationStep">
          <h2>Where Should We Film?</h2>
          <p id="locationDesc"></p>
          <div class="options-grid" id="locationGrid"></div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 6: B-ROLL STRATEGY -->
        <div class="step hidden" data-step="6" id="brollStep">
          <h2>B-Roll Strategy</h2>
          <p>How much background footage vs talking head?</p>
          <div class="options-grid">
            <label class="option-card" onclick="selectBroll('mostly', this)">
              <div class="option-icon">üé¨</div>
              <div class="option-name">Mostly B-Roll (70%)</div>
            </label>
            <label class="option-card" onclick="selectBroll('some', this)">
              <div class="option-icon">üé•</div>
              <div class="option-name">Some B-Roll (50%)</div>
            </label>
            <label class="option-card" onclick="selectBroll('none', this)">
              <div class="option-icon">üì±</div>
              <div class="option-name">No B-Roll</div>
            </label>
          </div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="nextStep()">Next ‚Üí</button>
          </div>
        </div>

        <!-- STEP 7: FINAL SETTINGS & GENERATE -->
        <div class="step hidden" data-step="7" id="finalStep">
          <h2>Reel Settings & Generate</h2>
          <p>Final touches before generating your storyboard</p>
          <div class="form-group">
            <label class="form-label">Reel Length</label>
            <select id="reelLength" class="form-select" onchange="document.getElementById('summaryReel').textContent = this.value + 's'">
              <option value="15">15 seconds</option>
              <option value="30" selected>30 seconds</option>
              <option value="45">45 seconds</option>
              <option value="60">60 seconds</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Video Tone/Voice</label>
            <select id="voiceTone" class="form-select">
              <option value="">Select...</option>
              <option value="Warm & Friendly">Warm & Friendly</option>
              <option value="Bold & Energetic">Bold & Energetic</option>
              <option value="Professional & Authoritative">Professional & Authoritative</option>
              <option value="Witty & Humorous">Witty & Humorous</option>
              <option value="Inspirational">Inspirational</option>
            </select>
          </div>
          <div class="step-actions">
            <button class="btn btn-secondary" onclick="prevStep()">‚Üê Back</button>
            <button class="btn btn-primary" onclick="generateStoryboard()">‚ú® Generate Storyboard ‚Üí</button>
          </div>
        </div>
      </div>

      <aside class="sidebar">
        <h3>Summary</h3>
        <div class="summary-row">
          <span class="summary-label">Business:</span>
          <span class="summary-value" id="summaryBiz">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Objective:</span>
          <span class="summary-value" id="summaryObjective">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Audience:</span>
          <span class="summary-value" id="summaryAudience">-</span>
        </div>
        <div class="summary-row">
          <span class="summary-label">Reel Length:</span>
          <span class="summary-value" id="summaryReel">30s</span>
        </div>
      </aside>
    </div>
  </div>

  <script>
    let state = {
      business: null,
      objective: null,
      campaignDetails: {},
      websiteUrl: null,
      businessName: null,
      uvp: null,
      ageRange: null,
      genderDiversity: null,
      primarySetting: null,
      locations: [],
      broll: null,
      reelLength: 30,
      voiceTone: null
    };

    const businessData = {
      restaurant: { 
        name: 'Restaurant', 
        locations: ['Kitchen', 'Dining Area', 'Counter', 'Prep Station', 'Entrance', 'Patio'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'Brand Intro', desc: 'Story & history' },
          { id: 'product', icon: 'üçΩÔ∏è', name: 'Product Showcase', desc: 'Signature dish' },
          { id: 'team', icon: 'üë•', name: 'Meet the Team', desc: 'Chef/owner' },
          { id: 'seasonal', icon: 'üéâ', name: 'Seasonal Special', desc: 'Limited offer' },
          { id: 'flash', icon: 'üî•', name: 'Flash Sale', desc: 'Daily deal' },
          { id: 'educational', icon: 'üìö', name: 'How-To/Educational', desc: 'Recipe/technique' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Testimonial', desc: 'Customer story' }
        ]
      },
      cafe: { 
        name: 'Cafe', 
        locations: ['Counter', 'Seating Area', 'Kitchen', 'Patio', 'Entrance'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'Brand Intro', desc: 'Cafe story' },
          { id: 'product', icon: '‚òï', name: 'Menu Showcase', desc: 'Drinks/pastries' },
          { id: 'team', icon: 'üë•', name: 'Meet the Barista', desc: 'Staff spotlight' },
          { id: 'seasonal', icon: 'üéâ', name: 'Seasonal Drink', desc: 'New menu item' },
          { id: 'flash', icon: 'üî•', name: 'Limited Time Offer', desc: 'Quick promo' },
          { id: 'educational', icon: 'üìö', name: 'Coffee Tips', desc: 'How-to guide' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Customer Love', desc: 'Reviews' }
        ]
      },
      bar: { 
        name: 'Bar', 
        locations: ['Bar Counter', 'Seating', 'Dance Floor', 'VIP Area', 'Entrance'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'Vibe & Culture', desc: 'Bar atmosphere' },
          { id: 'product', icon: 'üç∏', name: 'Signature Drink', desc: 'Cocktail feature' },
          { id: 'team', icon: 'üë•', name: 'Meet the Mixologist', desc: 'Bartender' },
          { id: 'seasonal', icon: 'üéâ', name: 'Happy Hour', desc: 'Special pricing' },
          { id: 'flash', icon: 'üî•', name: 'Tonight Only', desc: 'Flash promo' },
          { id: 'educational', icon: 'üìö', name: 'Drink Tutorial', desc: 'How it\'s made' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Guest Experience', desc: 'Reviews' }
        ]
      },
      hotel: { 
        name: 'Hotel', 
        locations: ['Lobby', 'Guest Room', 'Restaurant', 'Pool/Spa', 'Conference Room'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'Brand Story', desc: 'Hotel heritage' },
          { id: 'product', icon: 'üè®', name: 'Room Showcase', desc: 'Amenities' },
          { id: 'team', icon: 'üë•', name: 'Meet Our Team', desc: 'Staff' },
          { id: 'seasonal', icon: 'üéâ', name: 'Seasonal Package', desc: 'Special rates' },
          { id: 'flash', icon: 'üî•', name: 'Last-Minute Deal', desc: 'Limited bookings' },
          { id: 'educational', icon: 'üìö', name: 'Travel Tips', desc: 'Destination guide' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Guest Reviews', desc: 'Testimonials' }
        ]
      },
      wellness: { 
        name: 'Wellness', 
        locations: ['Studio', 'Equipment Room', 'Spa Area', 'Outdoor Space', 'Lobby'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'Mission & Values', desc: 'Wellness philosophy' },
          { id: 'product', icon: 'üí™', name: 'Class Showcase', desc: 'Fitness classes' },
          { id: 'team', icon: 'üë•', name: 'Meet Your Trainer', desc: 'Coach spotlight' },
          { id: 'seasonal', icon: 'üéâ', name: 'New Year/Season', desc: 'Seasonal promo' },
          { id: 'flash', icon: 'üî•', name: 'Limited Trial', desc: '7-day free pass' },
          { id: 'educational', icon: 'üìö', name: 'Fitness Tip', desc: 'Health advice' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Transformation', desc: 'Member success' }
        ]
      },
      education: { 
        name: 'Education', 
        locations: ['Classroom', 'Lab/Demo Space', 'Office', 'Outdoor', 'Studio'],
        objectives: [
          { id: 'brand', icon: 'üìà', name: 'School Intro', desc: 'Mission & values' },
          { id: 'product', icon: 'üìñ', name: 'Course Overview', desc: 'Curriculum' },
          { id: 'team', icon: 'üë•', name: 'Meet the Instructor', desc: 'Teacher spotlight' },
          { id: 'seasonal', icon: 'üéâ', name: 'Enrollment Push', desc: 'New cohort' },
          { id: 'flash', icon: 'üî•', name: 'Early Bird Bonus', desc: 'Limited seats' },
          { id: 'educational', icon: 'üìö', name: 'Free Lesson Preview', desc: 'Sample content' },
          { id: 'testimonial', icon: '‚≠ê', name: 'Student Success', desc: 'Graduate stories' }
        ]
      }
    };

    const campaignDetailsFields = {
      brand: {
        title: 'Brand Story',
        desc: 'What makes your story unique?',
        fields: [
          { name: 'storyAngle', label: 'What\'s your origin or key story?', placeholder: 'e.g., Founded in 1993 by a family with a passion for authentic cuisine', type: 'textarea' },
          { name: 'emotion', label: 'What emotion should viewers feel?', placeholder: 'e.g., Nostalgia, trust, excitement', type: 'text' }
        ]
      },
      product: {
        title: 'Product/Service Details',
        desc: 'What are you showcasing?',
        fields: [
          { name: 'productName', label: 'Product/Service name', placeholder: 'e.g., Our signature kufta burger', type: 'text' },
          { name: 'whySpecial', label: 'Why is it special?', placeholder: 'e.g., Hand-made with family recipe, premium ingredients', type: 'text' }
        ]
      },
      team: {
        title: 'Team Member Info',
        desc: 'Who are we featuring?',
        fields: [
          { name: 'teamMember1Name', label: 'Team Member 1 - Name', placeholder: 'e.g., Chef Ahmed', type: 'text' },
          { name: 'teamMember1Role', label: 'Team Member 1 - Role', placeholder: 'e.g., Executive Chef', type: 'text' },
          { name: 'teamMember1Story', label: 'Team Member 1 - Their story', placeholder: 'e.g., 25 years experience, trained in Lebanon', type: 'textarea' }
        ]
      },
      seasonal: {
        title: 'Seasonal Special Details',
        desc: 'What\'s the limited offer?',
        fields: [
          { name: 'offer', label: 'What\'s the offer?', placeholder: 'e.g., $12 kufta burger + fries', type: 'text' },
          { name: 'validWhen', label: 'Valid when?', placeholder: 'e.g., Dec 10-24, after 4pm', type: 'text' }
        ]
      },
      flash: {
        title: 'Flash Sale Details',
        desc: 'Create urgency!',
        fields: [
          { name: 'deal', label: 'What\'s the deal?', placeholder: 'e.g., BOGO burgers', type: 'text' },
          { name: 'timeWindow', label: 'Time window', placeholder: 'e.g., Today only 5-9pm', type: 'text' },
          { name: 'scarcity', label: 'Scarcity angle (optional)', placeholder: 'e.g., First 30 customers', type: 'text' }
        ]
      },
      educational: {
        title: 'Educational Content',
        desc: 'What will viewers learn?',
        fields: [
          { name: 'topic', label: 'Topic/What you\'re teaching', placeholder: 'e.g., How to make a perfect kufta at home', type: 'text' },
          { name: 'takeaway', label: 'Key takeaway/result', placeholder: 'e.g., Viewer can recreate the dish with pro tips', type: 'textarea' }
        ]
      },
      testimonial: {
        title: 'Customer Testimonial',
        desc: 'Share a success story',
        fields: [
          { name: 'customerName', label: 'Customer name & context', placeholder: 'e.g., Sarah, weekly customer for 2 years', type: 'text' },
          { name: 'customerStory', label: 'Their story or quote', placeholder: 'e.g., "This is the only place my kids will eat. Worth the drive!" ', type: 'textarea' }
        ]
      }
    };

    let currentStep = 1;
    let visibleSteps = [];

    function selectGoal(goal, elem) {
      document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('selected'));
      elem.classList.add('selected');
      document.getElementById('continueBtn').disabled = false;
    }

    function selectBusiness(biz, elem) {
      state.business = biz;
      document.querySelectorAll('#businessGrid .option-card').forEach(c => c.classList.remove('selected'));
      elem.classList.add('selected');
      document.getElementById('summaryBiz').textContent = businessData[biz].name;
    }

    // BUG FIX #1: Objective grid now populates after nextStep increments
    function populateObjectives() {
      if (!state.business) return;
      const objectives = businessData[state.business].objectives;
      const grid = document.getElementById('objectiveGrid');
      grid.innerHTML = objectives.map(obj => 
        `<label class="option-card" onclick="selectObjective('${obj.id}', this)">
          <div class="option-icon">${obj.icon}</div>
          <div class="option-name">${obj.name}</div>
          <div style="font-size: 11px; color: #999; margin-top: 4px;">${obj.desc}</div>
        </label>`
      ).join('');
    }

    function selectObjective(objId, elem) {
      state.objective = objId;
      document.querySelectorAll('#objectiveGrid .option-card').forEach(c => c.classList.remove('selected'));
      elem.classList.add('selected');
      
      const objectives = businessData[state.business].objectives;
      const selected = objectives.find(o => o.id === objId);
      document.getElementById('summaryObjective').textContent = selected.name;
    }

    // BUG FIX #2: Campaign details now handles missing objective gracefully + supports textarea
    function populateCampaignDetails() {
      if (!state.objective) {
        const content = document.getElementById('campaignDetailsContent');
        content.innerHTML = '<p style="color: #999; text-align: center; padding: 40px;">‚ö†Ô∏è Please go back and select a campaign objective</p>';
        return;
      }
      
      const detailConfig = campaignDetailsFields[state.objective];
      if (!detailConfig) {
        console.error('No campaign details config found for:', state.objective);
        return;
      }

      const title = document.getElementById('campaignDetailsTitle');
      const desc = document.getElementById('campaignDetailsDesc');
      const content = document.getElementById('campaignDetailsContent');

      title.textContent = detailConfig.title;
      desc.textContent = detailConfig.desc;
      
      // CHANGE #1: Support textarea for longer form fields
      content.innerHTML = detailConfig.fields.map(field => {
        if (field.type === 'textarea') {
          return `
            <div class="form-group">
              <label class="form-label">${field.label}</label>
              <textarea class="form-input" placeholder="${field.placeholder}" onchange="state.campaignDetails['${field.name}'] = this.value;" style="min-height: 150px; resize: vertical;"></textarea>
            </div>
          `;
        } else {
          return `
            <div class="form-group">
              <label class="form-label">${field.label}</label>
              <input type="text" class="form-input" placeholder="${field.placeholder}" onchange="state.campaignDetails['${field.name}'] = this.value;">
            </div>
          `;
        }
      }).join('');
    }

    function selectBroll(type, elem) {
      state.broll = type;
      document.querySelectorAll('#brollStep .option-card').forEach(c => c.classList.remove('selected'));
      elem.classList.add('selected');
    }

    function continueToWizard() {
      document.getElementById('goalScreen').classList.add('hidden');
      document.getElementById('wizardScreen').classList.remove('hidden');
      populateStepFlow();
      updateStepDisplay();
    }

    // CHANGE #2: Start Over button - resets everything
    function startOver() {
      state = {
        business: null,
        objective: null,
        campaignDetails: {},
        websiteUrl: null,
        businessName: null,
        uvp: null,
        ageRange: null,
        genderDiversity: null,
        primarySetting: null,
        locations: [],
        broll: null,
        reelLength: 30,
        voiceTone: null
      };
      
      // Reset UI
      document.querySelectorAll('.goal-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('#businessGrid .option-card').forEach(c => c.classList.remove('selected'));
      document.querySelectorAll('#objectiveGrid .option-card').forEach(c => c.classList.remove('selected'));
      
      // Clear form inputs
      document.getElementById('websiteUrl').value = '';
      document.getElementById('businessName').value = '';
      document.getElementById('uvp').value = '';
      document.getElementById('ageRange').value = '';
      document.getElementById('genderDiversity').value = '';
      document.getElementById('primarySetting').value = '';
      document.getElementById('reelLength').value = '30';
      document.getElementById('voiceTone').value = '';
      document.getElementById('apiInput').value = '';
      
      // Reset sidebar
      document.getElementById('summaryBiz').textContent = '-';
      document.getElementById('summaryObjective').textContent = '-';
      document.getElementById('summaryAudience').textContent = '-';
      document.getElementById('summaryReel').textContent = '30s';
      
      // Show goal screen again
      document.getElementById('goalScreen').classList.remove('hidden');
      document.getElementById('wizardScreen').classList.add('hidden');
      
      // Reset continue button
      document.getElementById('continueBtn').disabled = true;
    }

    function populateStepFlow() {
      const allSteps = document.querySelectorAll('.step');
      allSteps.forEach(s => s.classList.add('hidden'));
      
      document.querySelectorAll('[data-step="1"]')[0].classList.remove('hidden');
      document.querySelectorAll('[data-step="2"]')[0].classList.remove('hidden');
      document.getElementById('campaignDetailsStep').classList.remove('hidden');
      document.querySelectorAll('[data-step="4"]')[0].classList.remove('hidden');
      document.getElementById('locationStep').classList.remove('hidden');
      document.getElementById('brollStep').classList.remove('hidden');
      document.getElementById('finalStep').classList.remove('hidden');
      
      visibleSteps = Array.from(document.querySelectorAll('.step')).filter(s => !s.classList.contains('hidden'));
      currentStep = 1;
    }

    function populateLocations() {
      if (!state.business) return;
      const locs = businessData[state.business].locations;
      document.getElementById('locationDesc').textContent = `Choose filming location(s) for ${businessData[state.business].name}`;
      const grid = document.getElementById('locationGrid');
      grid.innerHTML = locs.map(loc => 
        `<label class="option-card" onclick="selectLocation('${loc}', this)">
          <div class="option-icon">üìç</div>
          <div class="option-name">${loc}</div>
        </label>`
      ).join('');
    }

    function selectLocation(loc, elem) {
      if (!state.locations.includes(loc)) state.locations = [loc];
      document.querySelectorAll('#locationGrid .option-card').forEach(c => c.classList.remove('selected'));
      elem.classList.add('selected');
    }

    // BUG FIX #1: Move populate calls AFTER step increment
    function nextStep() {
      currentStep++;
      updateStepDisplay();
      
      // Populate content AFTER moving to new step
      if (currentStep === 2) {
        populateObjectives();
      } else if (currentStep === 3) {
        populateCampaignDetails();
      } else if (currentStep === 5) {
        populateLocations();
      }
    }

    // BUG FIX #3: Back button re-populates content when going backwards
    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateStepDisplay();
        
        // Re-populate content when going back
        if (currentStep === 2 && state.business) {
          populateObjectives();
        } else if (currentStep === 3 && state.objective) {
          populateCampaignDetails();
        } else if (currentStep === 5 && state.business) {
          populateLocations();
        }
      }
    }

    function updateStepDisplay() {
      visibleSteps.forEach((s, i) => {
        s.classList.remove('active');
        if (i === currentStep - 1) s.classList.add('active');
      });
      
      updateProgress();
    }

    function updateProgress() {
      const pct = (currentStep / visibleSteps.length) * 100;
      document.getElementById('progressFill').style.width = pct + '%';
      document.getElementById('stepCounter').textContent = `Step ${currentStep} of ${visibleSteps.length}`;
    }

    // BUG FIX #4: Real-time summary sidebar updates
    function updateAudienceSummary() {
      const age = document.getElementById('ageRange').value;
      const gender = document.getElementById('genderDiversity').value;
      const setting = document.getElementById('primarySetting').value;
      
      let summary = [];
      if (age) summary.push(age.split('(')[0].trim());
      if (gender) summary.push(gender);
      if (setting) summary.push(setting.split('/')[0]);
      
      document.getElementById('summaryAudience').textContent = summary.length > 0 ? summary.join(' | ') : '-';
    }

    function toggleApiVis() {
      const input = document.getElementById('apiInput');
      const btn = document.getElementById('toggleApiBtn');
      if (input.type === 'password') {
        input.type = 'text';
        btn.textContent = 'üôà Hide';
      } else {
        input.type = 'password';
        btn.textContent = 'üëÅÔ∏è Show';
      }
    }

    async function generateStoryboard() {
      const apiKey = document.getElementById('apiInput').value;
      if (!apiKey) {
        alert('Enter API key');
        return;
      }

      state.websiteUrl = document.getElementById('websiteUrl').value;
      state.businessName = document.getElementById('businessName').value || 'Your Business';
      state.uvp = document.getElementById('uvp').value || 'Premium quality';
      state.ageRange = document.getElementById('ageRange').value || 'Mixed';
      state.genderDiversity = document.getElementById('genderDiversity').value || 'All';
      state.primarySetting = document.getElementById('primarySetting').value || 'Mixed';
      state.reelLength = document.getElementById('reelLength').value;
      state.voiceTone = document.getElementById('voiceTone').value || 'Professional';

      const prompt = buildEnhancedPrompt();

      try {
        const btn = event.target;
        btn.textContent = '‚è≥ Generating...';
        btn.disabled = true;

        const resp = await fetch('https://api.perplexity.ai/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
          body: JSON.stringify({ model: 'sonar', messages: [{ role: 'user', content: prompt }], max_tokens: 4000 })
        });
        if (!resp.ok) throw new Error('API Error: ' + resp.statusText);
        const data = await resp.json();
        const storyboard = data.choices[0].message.content;

        const win = window.open('', '_blank', 'width=1000,height=800');
        win.document.write(`<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Video Storyboard - ${state.businessName}</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; margin: 0; padding: 40px; }
    .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 12px; padding: 40px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
    h1 { color: #333; border-bottom: 3px solid #667eea; padding-bottom: 15px; }
    .metadata { background: #f9f9f9; padding: 15px; border-radius: 8px; margin: 20px 0; font-size: 14px; }
    .metadata div { margin: 8px 0; }
    .label { font-weight: 600; color: #666; }
    .value { color: #333; }
    pre { background: #f5f5f5; padding: 20px; border-radius: 8px; overflow-x: auto; font-size: 13px; line-height: 1.6; }
    button { background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
    button:hover { background: #764ba2; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üé¨ ${state.businessName} - Video Storyboard</h1>
    <div class="metadata">
      <div><span class="label">Business Type:</span> <span class="value">${businessData[state.business].name}</span></div>
      <div><span class="label">Objective:</span> <span class="value">${state.objective.toUpperCase()}</span></div>
      <div><span class="label">Duration:</span> <span class="value">${state.reelLength} seconds</span></div>
      <div><span class="label">Target Audience:</span> <span class="value">${state.ageRange} | ${state.genderDiversity} | ${state.primarySetting}</span></div>
      <div><span class="label">Tone:</span> <span class="value">${state.voiceTone}</span></div>
      <div><span class="label">Filming Locations:</span> <span class="value">${state.locations.join(', ')}</span></div>
      <div><span class="label">B-Roll Strategy:</span> <span class="value">${state.broll === 'mostly' ? '70% B-Roll' : state.broll === 'some' ? '50% B-Roll' : 'No B-Roll'}</span></div>
    </div>
    <pre>${storyboard}</pre>
    <button onclick="window.print()">üñ®Ô∏è Print/Save as PDF</button>
  </div>
</body>
</html>`);
        btn.textContent = '‚ú® Generate Storyboard ‚Üí';
        btn.disabled = false;
      } catch (e) {
        alert('Error: ' + e.message);
        event.target.textContent = '‚ú® Generate Storyboard ‚Üí';
        event.target.disabled = false;
      }
    }

    function buildEnhancedPrompt() {
      let prompt = `You are an expert video production director. Generate a detailed, production-ready video storyboard with the following context:

BUSINESS CONTEXT:
- Business Type: ${businessData[state.business].name}
- Business Name: ${state.businessName}
- USP: ${state.uvp}
- Website: ${state.websiteUrl || 'Not provided'}

CAMPAIGN DETAILS:
- Objective: ${state.objective.toUpperCase()}
`;

      Object.entries(state.campaignDetails).forEach(([key, value]) => {
        if (value) {
          prompt += `- ${key.charAt(0).toUpperCase() + key.slice(1)}: ${value}\n`;
        }
      });

      prompt += `
TARGET AUDIENCE:
- Age Range: ${state.ageRange}
- Gender Diversity: ${state.genderDiversity}
- Primary Setting/Context: ${state.primarySetting}

PRODUCTION SPECIFICATIONS:
- Duration: ${state.reelLength} seconds
- Format: Reel (9:16 mobile-first)
- B-Roll Strategy: ${state.broll === 'mostly' ? '70% Background Footage + 30% Talking Head' : state.broll === 'some' ? '50% Balanced Mix' : '100% Talking Head - Direct to Camera'}
- Tone/Voice: ${state.voiceTone}
- Filming Locations: ${state.locations.join(', ')}

STORYBOARD STRUCTURE (Generate exactly ${Math.ceil(state.reelLength / 15)} scenes):
For each scene, provide:
1. SCRIPT: Exact voiceover/dialogue (word count ~${Math.round(state.reelLength * 2)} words total)
2. SHOT LIST: Specific camera shots, angles, movements, duration in seconds
3. B-ROLL SUGGESTIONS: Demographic-aware stock footage search terms including age, gender, setting
   Format: "subject, gender, age range, setting, mood/lighting"
4. PROPS/EQUIPMENT: What's needed in frame
5. TIMING: Exact duration of this scene in seconds

Demographics-Aware B-Roll Guidance:
Match casting and visuals to your audience. For example:
- Age: Millennials (26-40) ‚Üí Show relatable lifestyle, modern aesthetics
- Gender: Mixed ‚Üí Include diverse representation, multiple perspectives
- Setting: ${state.primarySetting} ‚Üí Prioritize relevant environments

FINAL OUTPUT FORMAT:
---
SCENE 1:
SCRIPT: [dialogue]
SHOT LIST: [details]
B-ROLL SUGGESTIONS: [stock search terms]
TIMING: [X seconds]

SCENE 2:
[repeat structure]

EQUIPMENT NEEDED: [camera gear, lighting, audio]
TOTAL PRODUCTION TIME: [estimated hours]
KEY INSIGHTS: [2-3 production tips specific to this objective]
---

Generate a storyboard that is specific, actionable, and ready for production. Use the objective and campaign details to inform creative choices.`;

      return prompt;
    }
  </script>
</body>
</html>