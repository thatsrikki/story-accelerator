<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Storyboard AI - Smart Video Builder</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
    .wizard-container { display: grid; grid-template-columns: 1fr 300px; gap: 30px; max-width: 1200px; margin: 0 auto; }
    .api-key-section { grid-column: 1 / -1; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; border: 2px solid #e0e0e0; }
    .api-key-section.valid { border-color: #4caf50; background: linear-gradient(135deg, rgba(76,175,80,0.02) 0%, rgba(76,175,80,0.02) 100%); }
    .api-key-content { display: flex; gap: 15px; align-items: flex-end; }
    .api-key-group { flex: 1; }
    .api-key-label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
    .api-key-input { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; font-family: 'Courier New', monospace; transition: all 0.3s ease; }
    .api-key-input:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #999; display: inline-block; }
    .status-dot.valid { background: #4caf50; }
    .status-text { color: #666; margin-left: 8px; }
    .status-text.valid { color: #4caf50; font-weight: 600; }
    .wizard-progress { grid-column: 1 / -1; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
    .progress-bar { height: 4px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin-bottom: 20px; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 14.28%; transition: width 0.3s ease; }
    .progress-steps { display: flex; justify-content: space-between; gap: 10px; }
    .progress-step { flex: 1; text-align: center; opacity: 0.5; transition: all 0.3s ease; }
    .progress-step.active, .progress-step.completed { opacity: 1; }
    .step-number { width: 40px; height: 40px; margin: 0 auto 10px; border-radius: 50%; background: #e0e0e0; display: flex; align-items: center; justify-content: center; font-weight: bold; }
    .progress-step.active .step-number { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .progress-step.completed .step-number { background: #4caf50; color: white; }
    .step-label { font-size: 12px; color: #666; font-weight: 500; }
    .progress-step.active .step-label, .progress-step.completed .step-label { color: #333; font-weight: 600; }
    .wizard-content { background: white; border-radius: 12px; padding: 40px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); }
    .wizard-step { display: block; opacity: 1; }
    .wizard-step.hidden { display: none; opacity: 0; }
    .step-header { margin-bottom: 30px; }
    .step-header h2 { font-size: 28px; color: #333; margin-bottom: 10px; }
    .step-description { color: #666; font-size: 16px; }
    .form-group { margin-bottom: 25px; }
    .form-group label { display: block; font-weight: 600; color: #333; margin-bottom: 8px; font-size: 14px; }
    .form-group input[type="text"], .form-group input[type="url"], .form-group input[type="number"], .form-group textarea, .form-group select { width: 100%; padding: 12px 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: all 0.3s ease; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .reel-length-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
    .reel-option { position: relative; }
    .reel-option input[type="radio"] { display: none; }
    .reel-label { display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; font-weight: 600; color: #666; cursor: pointer; transition: all 0.3s ease; background: white; }
    .reel-option input[type="radio"]:checked + .reel-label { background: #667eea; color: white; border-color: #667eea; }
    .business-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .business-card { cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; text-align: center; transition: all 0.3s ease; background: white; }
    .business-card input[type="radio"] { display: none; }
    .business-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102,126,234,0.2); transform: translateY(-2px); }
    .business-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); box-shadow: 0 4px 12px rgba(102,126,234,0.2); }
    .business-icon { font-size: 40px; margin-bottom: 10px; }
    .business-name { font-weight: 600; color: #333; font-size: 14px; margin-bottom: 5px; }
    .business-desc { font-size: 11px; color: #999; }
    .gender-selection { display: flex; flex-direction: column; gap: 15px; margin-bottom: 30px; }
    .gender-option { cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; display: flex; align-items: center; gap: 15px; transition: all 0.3s ease; background: white; }
    .gender-option input[type="radio"] { width: 20px; height: 20px; cursor: pointer; flex-shrink: 0; }
    .gender-option:hover { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); }
    .gender-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: bold; text-transform: uppercase; color: white; margin-right: 8px; }
    .gender-badge.default { background: #2196F3; }
    .gender-badge.women { background: #E91E63; }
    .gender-badge.men { background: #1E88E5; }
    .location-group, .location-group-secondary { margin-bottom: 25px; }
    .location-group h3, .location-group-secondary h3 { font-size: 14px; font-weight: 600; color: #667eea; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }
    .location-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px; }
    .location-checkbox { position: relative; }
    .location-checkbox input[type="checkbox"] { display: none; }
    .location-label { display: flex; align-items: center; justify-content: center; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 13px; font-weight: 500; color: #666; transition: all 0.3s ease; background: white; cursor: pointer; }
    .location-checkbox input[type="checkbox"]:checked + .location-label { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; box-shadow: 0 4px 8px rgba(102,126,234,0.3); }
    .feature-question { background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); border-left: 4px solid #667eea; padding: 15px; border-radius: 8px; margin-top: 20px; margin-bottom: 20px; }
    .feature-question p { font-size: 14px; color: #333; margin-bottom: 10px; font-weight: 500; }
    .feature-options { display: flex; gap: 10px; flex-wrap: wrap; }
    .feature-btn { padding: 8px 16px; border: 2px solid #e0e0e0; border-radius: 6px; background: white; cursor: pointer; font-size: 13px; transition: all 0.3s ease; }
    .feature-btn:hover, .feature-btn.selected { border-color: #667eea; background: #667eea; color: white; }
    .wellness-specialties { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
    .wellness-specialties.hidden { display: none; }
    .specialty-category { margin-bottom: 20px; }
    .specialty-category h4 { font-size: 13px; font-weight: 600; color: #667eea; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 10px; }
    .specialty-checkboxes { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 8px; }
    .specialty-checkbox input[type="checkbox"] { display: none; }
    .specialty-label { display: block; padding: 10px; border: 2px solid #ddd; border-radius: 6px; background: white; font-size: 12px; text-align: center; transition: all 0.3s ease; cursor: pointer; }
    .specialty-checkbox input[type="checkbox"]:checked + .specialty-label { background: #667eea; color: white; border-color: #667eea; }
    .broll-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .broll-card { cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; transition: all 0.3s ease; background: white; }
    .broll-card input[type="radio"] { display: none; }
    .broll-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102,126,234,0.2); }
    .broll-card.recommended { border-color: #4caf50; background: linear-gradient(135deg, rgba(76,175,80,0.05) 0%, rgba(76,175,80,0.05) 100%)); box-shadow: 0 4px 12px rgba(76,175,80,0.2); }
    .broll-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
    .broll-title { font-weight: 600; color: #333; }
    .broll-percent { font-size: 12px; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; white-space: nowrap; }
    .broll-desc { font-size: 13px; color: #666; margin-bottom: 8px; }
    .broll-example { font-size: 12px; color: #999; }
    .recommendation-box { background: linear-gradient(135deg, rgba(76,175,80,0.08) 0%, rgba(76,175,80,0.05) 100%); border-left: 4px solid #4caf50; padding: 20px; border-radius: 8px; margin-top: 20px; }
    .recommendation-content p { font-size: 14px; line-height: 1.6; margin-bottom: 10px; color: #333; }
    .bts-activities { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 30px; }
    .bts-checkbox input[type="checkbox"] { display: none; }
    .bts-label { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 15px; border: 2px solid #e0e0e0; border-radius: 10px; background: white; cursor: pointer; transition: all 0.3s ease; }
    .bts-checkbox input[type="checkbox"]:checked + .bts-label { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-color: #667eea; color: white; box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
    .bts-icon { font-size: 28px; margin-bottom: 8px; }
    .bts-title { font-weight: 600; font-size: 13px; margin-bottom: 4px; }
    .bts-desc { font-size: 11px; opacity: 0.8; }
    .tone-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
    .tone-card { cursor: pointer; border: 2px solid #e0e0e0; border-radius: 12px; padding: 20px; transition: all 0.3s ease; background: white; }
    .tone-card input[type="radio"] { display: none; }
    .tone-card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102,126,234,0.2); }
    .tone-card.selected { border-color: #667eea; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); box-shadow: 0 4px 12px rgba(102,126,234,0.2); }
    .tone-emoji { font-size: 32px; margin-bottom: 10px; }
    .tone-name { font-weight: 600; color: #333; font-size: 14px; margin-bottom: 5px; }
    .tone-desc { font-size: 12px; color: #999; line-height: 1.4; }
    .uvp-section { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    .uvp-section h3 { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; }
    .preview-card { background: linear-gradient(135deg, rgba(102,126,234,0.08) 0%, rgba(118,75,162,0.08) 100%); border: 2px dashed #667eea; border-radius: 10px; padding: 20px; margin-top: 20px; font-size: 13px; color: #666; }
    .preview-card.populated { border-style: solid; background: linear-gradient(135deg, rgba(102,126,234,0.05) 0%, rgba(118,75,162,0.05) 100%); }
    .preview-item { margin-bottom: 10px; }
    .preview-label { font-weight: 600; color: #667eea; }
    .preview-value { color: #333; }
    .review-section { background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 25px; }
    .review-section h3 { font-size: 16px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #ddd; }
    .review-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .review-item { background: white; padding: 12px; border-radius: 8px; border-left: 4px solid #667eea; }
    .review-item-label { font-size: 12px; font-weight: 600; color: #667eea; text-transform: uppercase; margin-bottom: 5px; }
    .review-item-value { font-size: 14px; color: #333; font-weight: 500; }
    .step-actions { display: flex; gap: 10px; margin-top: 30px; justify-content: space-between; }
    .btn-back, .btn-next, .btn-generate { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-back { background: #f0f0f0; color: #666; }
    .btn-back:hover { background: #e0e0e0; }
    .btn-next, .btn-generate { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; margin-left: auto; }
    .btn-next:hover, .btn-generate:hover { transform: translateY(-2px); box-shadow: 0 8px 16px rgba(102,126,234,0.3); }
    .btn-generate { width: 100%; padding: 16px 24px; font-size: 16px; }
    .wizard-preview-sidebar { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 8px 16px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 20px; }
    .preview-summary h3 { font-size: 18px; color: #333; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0; }
    .summary-item { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; gap: 10px; }
    .summary-label { font-weight: 600; color: #666; }
    .summary-value { color: #667eea; font-weight: 500; text-align: right; flex: 1; }
    .summary-divider { height: 1px; background: #e0e0e0; margin: 20px 0; }
    .recommendations-box { background: linear-gradient(135deg, rgba(102,126,234,0.08) 0%, rgba(118,75,162,0.08) 100%); padding: 15px; border-radius: 8px; border-left: 4px solid #667eea; }
    .recommendations-box h4 { font-size: 13px; color: #667eea; margin-bottom: 10px; font-weight: 600; }
    .recommendation-item { font-size: 12px; color: #555; margin-bottom: 8px; line-height: 1.4; }
    @media (max-width: 1024px) { .wizard-container { grid-template-columns: 1fr; } .wizard-preview-sidebar { position: static; } .form-row { grid-template-columns: 1fr; } }
    @media (max-width: 768px) { .step-actions { flex-direction: column; } .btn-next, .btn-generate { margin-left: 0; } .form-row { grid-template-columns: 1fr; } .reel-length-grid { grid-template-columns: repeat(2, 1fr); } }
    @media print { button { display: none; } .wizard-preview-sidebar { display: none; } }
  </style>
</head>
<body>
  <div class="wizard-container">
    <div class="api-key-section" id="apiKeySection">
      <div class="api-key-content">
        <div class="api-key-group" style="flex: 1;">
          <label class="api-key-label">üîë Perplexity API Key</label>
          <input type="password" id="apiKeyInput" class="api-key-input" placeholder="pplx-xxxxxxxxxxxxxxxxxxxxxxxx">
          <div style="font-size: 12px; color: #999; margin-top: 8px;">Get your key from <a href="https://www.perplexity.ai/settings/api" target="_blank" style="color: #667eea; text-decoration: none;">Perplexity Settings</a></div>
        </div>
        <div class="api-key-group">
          <label class="api-key-label">&nbsp;</label>
          <button id="toggleApiVisibility" style="padding: 12px 15px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px;">üëÅÔ∏è Show</button>
        </div>
      </div>
      <div style="margin-top: 8px;">
        <div class="status-dot" id="statusDot"></div><span class="status-text" id="statusText">No API key entered</span>
      </div>
    </div>

    <div class="wizard-progress">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <div class="progress-steps">
        <div class="progress-step active" data-step="1"><div class="step-number">1</div><div class="step-label">Business Type</div></div>
        <div class="progress-step" data-step="2"><div class="step-number">2</div><div class="step-label">Gender Focus</div></div>
        <div class="progress-step" data-step="3"><div class="step-number">3</div><div class="step-label">Locations</div></div>
        <div class="progress-step" data-step="4"><div class="step-number">4</div><div class="step-label">B-Roll</div></div>
        <div class="progress-step" data-step="5"><div class="step-number">5</div><div class="step-label">Behind-the-Scenes</div></div>
        <div class="progress-step" data-step="6"><div class="step-number">6</div><div class="step-label">Brand & Voice</div></div>
        <div class="progress-step" data-step="7"><div class="step-number">7</div><div class="step-label">Review & Generate</div></div>
      </div>
    </div>

    <div class="wizard-content">
      <div class="wizard-step" id="step1" data-step="1">
        <div class="step-header"><h2>What's Your Business Type?</h2><p class="step-description">This helps us tailor locations, activities, and B-roll recommendations</p></div>
        <div class="business-grid" id="businessGrid">
          <label class="business-card" data-value="restaurant"><input type="radio" name="businessType" value="restaurant"><div class="business-icon">üçΩÔ∏è</div><div class="business-name">Restaurant</div><div class="business-desc">Fine dining, casual, or quick service</div></label>
          <label class="business-card" data-value="cafe"><input type="radio" name="businessType" value="cafe"><div class="business-icon">‚òï</div><div class="business-name">Cafe</div><div class="business-desc">Coffee shop or bakery</div></label>
          <label class="business-card" data-value="bar"><input type="radio" name="businessType" value="bar"><div class="business-icon">üç∏</div><div class="business-name">Bar/Lounge</div><div class="business-desc">Cocktail bar or lounge venue</div></label>
          <label class="business-card" data-value="hotel"><input type="radio" name="businessType" value="hotel"><div class="business-icon">üè®</div><div class="business-name">Hotel</div><div class="business-desc">Hospitality & accommodations</div></label>
          <label class="business-card" data-value="wellness"><input type="radio" name="businessType" value="wellness"><div class="business-icon">üí™</div><div class="business-name">Wellness/Fitness</div><div class="business-desc">Gym, studio, or wellness center</div></label>
          <label class="business-card" data-value="education"><input type="radio" name="businessType" value="education"><div class="business-icon">üìö</div><div class="business-name">Education</div><div class="business-desc">Online course or training</div></label>
          <label class="business-card" data-value="service_based"><input type="radio" name="businessType" value="service_based"><div class="business-icon">üéØ</div><div class="business-name">Service-Based</div><div class="business-desc">Coaching, consulting, freelance</div></label>
        </div>
        <div class="step-actions"><button class="btn-next" id="next1">Next: Gender Focus ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step2" data-step="2">
        <div class="step-header"><h2>Who Should Be in Your B-Roll?</h2><p class="step-description">This helps us recommend the right talent and diversity approach</p></div>
        <div class="gender-selection">
          <label class="gender-option"><input type="radio" name="gender" value="both" checked><div style="flex: 1;"><div style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #333; margin-bottom: 5px;"><span class="gender-badge default">Default</span>Both Genders</div><div style="font-size: 13px; color: #999;">Natural diversity - shows inclusive workplace/community</div></div></label>
          <label class="gender-option"><input type="radio" name="gender" value="women"><div style="flex: 1;"><div style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #333; margin-bottom: 5px;"><span class="gender-badge women">Women Focus</span>Women-Focused</div><div style="font-size: 13px; color: #999;">For women's empowerment, women-only services, or women-led businesses</div></div></label>
          <label class="gender-option"><input type="radio" name="gender" value="men"><div style="flex: 1;"><div style="display: flex; align-items: center; gap: 10px; font-weight: 600; color: #333; margin-bottom: 5px;"><span class="gender-badge men">Men Focus</span>Men-Focused</div><div style="font-size: 13px; color: #999;">For men-specific services, men's groups, or men-led training</div></div></label>
        </div>
        <div class="preview-card" id="genderPreview"></div>
        <div class="step-actions"><button class="btn-back" id="back2">‚Üê Back</button><button class="btn-next" id="next2">Next: Locations ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step3" data-step="3">
        <div class="step-header"><h2>Where Should We Film?</h2><p class="step-description" id="locationDescription"></p></div>
        <div class="locations-section">
          <div class="location-group" id="primaryLocations"></div>
          <div class="location-group-secondary" id="secondaryLocations"></div>
          <div id="wellnessSpecialties" class="wellness-specialties hidden"></div>
        </div>
        <div class="feature-question" id="featureQuestion"></div>
        <div class="preview-card" id="locationPreview"></div>
        <div class="step-actions"><button class="btn-back" id="back3">‚Üê Back</button><button class="btn-next" id="next3">Next: B-Roll Strategy ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step4" data-step="4">
        <div class="step-header"><h2>What's Your B-Roll Strategy?</h2><p class="step-description">How much background footage supports your talking head content?</p></div>
        <div class="broll-options">
          <label class="broll-card"><input type="radio" name="brollStrategy" value="all"><div class="broll-header"><div class="broll-title">All B-Roll</div><div class="broll-percent">0% Talking Head</div></div><div class="broll-desc">Pure visual storytelling, no host speaking</div><div class="broll-example">üìπ Cinematic showcase reel</div></label>
          <label class="broll-card"><input type="radio" name="brollStrategy" value="mostly"><div class="broll-header"><div class="broll-title">Mostly B-Roll</div><div class="broll-percent">20-30% Talking Head</div></div><div class="broll-desc">Host briefly introduces/concludes, B-roll shows action</div><div class="broll-example">üé¨ Documentary-style with voiceover</div></label>
          <label class="broll-card"><input type="radio" name="brollStrategy" value="some"><div class="broll-header"><div class="broll-title">Some B-Roll</div><div class="broll-percent">50% Talking Head, 50% B-Roll</div></div><div class="broll-desc">Balanced between host and visual storytelling</div><div class="broll-example">üé• Interview with supporting footage</div></label>
          <label class="broll-card"><input type="radio" name="brollStrategy" value="none"><div class="broll-header"><div class="broll-title">No B-Roll</div><div class="broll-percent">100% Talking Head</div></div><div class="broll-desc">Host-focused, minimal supplemental footage</div><div class="broll-example">üì± Direct-to-camera content</div></label>
        </div>
        <div class="recommendation-box" id="brollRecommendation"></div>
        <div class="preview-card" id="brollPreview"></div>
        <div class="step-actions"><button class="btn-back" id="back4">‚Üê Back</button><button class="btn-next" id="next4">Next: Behind-the-Scenes ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step5" data-step="5">
        <div class="step-header"><h2>What Activities Should We Capture?</h2><p class="step-description">Select all the behind-the-scenes moments that show your business in action</p></div>
        <div class="bts-activities" id="btsActivities"></div>
        <div class="preview-card" id="btsPreview"></div>
        <div class="step-actions"><button class="btn-back" id="back5">‚Üê Back</button><button class="btn-next" id="next5">Next: Brand & Voice ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step6" data-step="6">
        <div class="step-header"><h2>Define Your Brand & Voice</h2><p class="step-description">This shapes the authenticity and narrative style of your video</p></div>
        <div class="uvp-section">
          <h3>üìã Business Information</h3>
          <div class="form-row">
            <div class="form-group"><label>Business Name</label><input type="text" id="businessName" placeholder="e.g., Jerusalem Grill and Deli"></div>
            <div class="form-group"><label>Hero Product/Focus</label><input type="text" id="heroProduct" placeholder="e.g., Kufta Burgers"></div>
          </div>
          <div class="form-group"><label>Unique Value Proposition - What makes you DIFFERENT?</label><textarea id="uvpDifferentiation" placeholder="e.g., 30 years of hunger & hustle, hand-shaped kufta, real ingredients"></textarea></div>
          <div class="form-group"><label>What do you REFUSE to do?</label><textarea id="uvpBoundaries" placeholder="e.g., No frozen lies, no shortcuts, no processed BS"></textarea></div>
          <div class="form-group"><label>What EMOTION do you want to invoke?</label><input type="text" id="uvpEmotion" placeholder="e.g., Rebellion, authenticity, hunger, defiance"></div>
          <div class="form-group"><label>Origin Story (Optional)</label><textarea id="uvpHeritage" placeholder="e.g., Started in 1994 on Jerusalem streets..."></textarea></div>
        </div>
        <div class="uvp-section">
          <h3>üîó Digital Presence</h3>
          <div class="form-row">
            <div class="form-group"><label>Website URL</label><input type="url" id="websiteUrl" placeholder="https://yourwebsite.com"></div>
            <div class="form-group"><label>Instagram Handle</label><input type="text" id="instagramHandle" placeholder="@yourhandle"></div>
          </div>
          <div class="form-group"><label>Facebook Page URL</label><input type="url" id="facebookUrl" placeholder="https://facebook.com/yourpage"></div>
        </div>
        <div class="form-group">
          <label style="margin-bottom: 15px;">üé¨ Voice Style (Bourdain-Inspired)</label>
          <div class="tone-grid">
            <label class="tone-card"><input type="radio" name="toneStyle" value="cynical_witty"><div class="tone-emoji">üòè</div><div class="tone-name">Cynical & Witty</div><div class="tone-desc">Dry humor, street-smart digs</div></label>
            <label class="tone-card"><input type="radio" name="toneStyle" value="introspective_poetic"><div class="tone-emoji">üåô</div><div class="tone-name">Introspective & Poetic</div><div class="tone-desc">Deep musings, sensory metaphors</div></label>
            <label class="tone-card"><input type="radio" name="toneStyle" value="adventurous_bold"><div class="tone-emoji">‚ö°</div><div class="tone-name">Adventurous & Bold</div><div class="tone-desc">High-energy rants, dare-you-challenges</div></label>
            <label class="tone-card"><input type="radio" name="toneStyle" value="nostalgic_warm"><div class="tone-emoji">üî•</div><div class="tone-name">Nostalgic & Warm</div><div class="tone-desc">Subtle sentiment, family themes</div></label>
          </div>
        </div>
        <div class="uvp-section">
          <h3>üë• Audience Profile</h3>
          <div class="form-row">
            <div class="form-group"><label>Age Range</label><select id="ageRange"><option value="">Select age range...</option><option value="18-25">18-25 (Gen Z)</option><option value="25-35">25-35 (Millennials)</option><option value="35-50">35-50 (Gen X)</option><option value="50+">50+ (Boomers+)</option><option value="all">All Ages</option></select></div>
            <div class="form-group"><label>Psychographic Focus</label><select id="psychographic"><option value="">Select audience type...</option><option value="foodies">Foodies & Food Enthusiasts</option><option value="entrepreneurs">Entrepreneurs & Business Owners</option><option value="local">Local Community Members</option><option value="fitness">Fitness & Health Conscious</option><option value="students">Students & Learners</option><option value="general">General / All Types</option></select></div>
          </div>
        </div>
        <div class="step-actions"><button class="btn-back" id="back6">‚Üê Back</button><button class="btn-next" id="next6">Next: Review & Generate ‚Üí</button></div>
      </div>

      <div class="wizard-step hidden" id="step7" data-step="7">
        <div class="step-header"><h2>Review Your Production Brief</h2><p class="step-description">Everything looks good? Generate your complete production plan with shot lists</p></div>
        <div class="review-section">
          <h3>üìπ Production Brief</h3>
          <div class="review-grid" id="reviewBrief"></div>
        </div>
        <div class="uvp-section">
          <h3>üé¨ Reel Settings</h3>
          <div class="form-group">
            <label style="margin-bottom: 15px;">Target Reel Length</label>
            <div class="reel-length-grid">
              <label class="reel-option"><input type="radio" name="reelLength" value="15" checked><span class="reel-label">15s</span></label>
              <label class="reel-option"><input type="radio" name="reelLength" value="30"><span class="reel-label">30s</span></label>
              <label class="reel-option"><input type="radio" name="reelLength" value="60"><span class="reel-label">60s</span></label>
              <label class="reel-option"><input type="radio" name="reelLength" value="custom"><span class="reel-label">Custom</span></label>
            </div>
            <div id="customReelContainer" style="display: none;">
              <input type="number" id="customReelLength" placeholder="Enter seconds" min="10" max="300" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            </div>
          </div>
          <div class="form-group">
            <label>Number of Scenes</label>
            <select id="sceneCount">
              <option value="2">2 Scenes</option>
              <option value="3" selected>3 Scenes</option>
              <option value="4">4 Scenes</option>
              <option value="5">5 Scenes</option>
            </select>
          </div>
        </div>
        <div class="review-section"><h3>üé§ Brand & Voice</h3><div class="review-grid" id="reviewBrand"></div></div>
        <div class="step-actions"><button class="btn-back" id="back7">‚Üê Back</button><button class="btn-generate" id="generateStoryboard">‚ú® Generate My Production Plan & Shot List</button></div>
      </div>
    </div>

    <aside class="wizard-preview-sidebar">
      <div class="preview-summary">
        <h3>Your Video Summary</h3>
        <div class="summary-item"><span class="summary-label">Business:</span><span class="summary-value" id="summaryBusiness">Not selected</span></div>
        <div class="summary-item"><span class="summary-label">Gender Focus:</span><span class="summary-value" id="summaryGender">Both Genders</span></div>
        <div class="summary-item"><span class="summary-label">Primary Location:</span><span class="summary-value" id="summaryLocation">Not selected</span></div>
        <div class="summary-item"><span class="summary-label">B-Roll Strategy:</span><span class="summary-value" id="summaryBroll">Not selected</span></div>
        <div class="summary-item"><span class="summary-label">Activities:</span><span class="summary-value" id="summaryActivities">0 selected</span></div>
        <div class="summary-item"><span class="summary-label">Voice Style:</span><span class="summary-value" id="summaryTone">Not selected</span></div>
        <div class="summary-item"><span class="summary-label">Reel Length:</span><span class="summary-value" id="summaryReel">15s</span></div>
        <div class="summary-divider"></div>
        <div class="recommendations-box"><h4>üí° Recommendations</h4><div id="recommendationsList"></div></div>
      </div>
    </aside>
  </div>

  <script>
    // DATA STRUCTURES
    const businessContextMap = {
      restaurant: { label: 'Restaurant', locations: { primary: ['Kitchen', 'Dining Area', 'Front Counter', 'Prep Station'], secondary: ['Storage', 'Bathroom', 'Entrance'], highlights: ['Kitchen (hero location)', 'Dining Area (lifestyle)'], featureQuestion: 'Which area best shows your value?' }, behindTheScenes: [{ id: 'prep', label: 'Food Preparation', icon: 'üî™', description: 'Ingredient sourcing, cutting, prep work' }, { id: 'plating', label: 'Plating & Presentation', icon: 'üçΩÔ∏è', description: 'Plating technique, final touches' }, { id: 'quality', label: 'Quality Checks', icon: '‚úÖ', description: 'Quality control, tasting, consistency' }, { id: 'staff', label: 'Staff Training/Interaction', icon: 'üë•', description: 'Team working together' }, { id: 'sourcing', label: 'Sourcing/Suppliers', icon: 'üì¶', description: 'Local sourcing' }], brollRecommendation: { recommended: 'mostly', reason: 'Food and action are visually compelling.', percentage: '70% B-Roll' } },
      cafe: { label: 'Cafe', locations: { primary: ['Counter', 'Seating Area', 'Kitchen/Bar', 'Patio'], secondary: ['Bathroom', 'Entrance', 'Waiting Area'], highlights: ['Counter (barista showcase)', 'Seating (community)'], featureQuestion: 'Cozy counter or spacious seating?' }, behindTheScenes: [{ id: 'prep', label: 'Drink Preparation', icon: '‚òï', description: 'Espresso machine, milk steaming, latte art' }, { id: 'pastries', label: 'Pastry/Food Prep', icon: 'ü•ê', description: 'Baking, arranging' }, { id: 'customers', label: 'Customer Interaction', icon: 'üë•', description: 'Taking orders, chatting' }, { id: 'atmosphere', label: 'Atmosphere/Community', icon: 'ü§ù', description: 'People gathering' }], brollRecommendation: { recommended: 'mostly', reason: 'Showcase cozy atmosphere and barista craft.', percentage: '70% B-Roll' } },
      bar: { label: 'Bar/Lounge', locations: { primary: ['Bar Counter', 'Seating/Booths', 'Dance Floor', 'Lounge'], secondary: ['Bathroom', 'Entrance', 'Private Room'], highlights: ['Bar Counter (bartender skills)', 'Atmosphere (vibe)'], featureQuestion: 'What\'s your unique bar experience?' }, behindTheScenes: [{ id: 'cocktails', label: 'Cocktail Making', icon: 'üç∏', description: 'Mixing, pouring, garnishing' }, { id: 'atmosphere', label: 'Atmosphere & Vibes', icon: '‚ú®', description: 'Lighting, music, energy' }, { id: 'service', label: 'Service Excellence', icon: 'üõéÔ∏è', description: 'Staff interaction' }, { id: 'events', label: 'Events/Entertainment', icon: 'üé§', description: 'DJ sets, live music' }], brollRecommendation: { recommended: 'some', reason: 'Mix your personality with bartending craft.', percentage: '50-60% B-Roll' } },
      hotel: { label: 'Hotel', locations: { primary: ['Lobby', 'Guest Room', 'Restaurant', 'Conference'], secondary: ['Spa', 'Pool', 'Business Center', 'Concierge Desk'], highlights: ['Lobby (first impression)', 'Room (core product)'], featureQuestion: 'What\'s your signature experience?' }, behindTheScenes: [{ id: 'checkin', label: 'Check-In Process', icon: 'üîë', description: 'Welcoming guests' }, { id: 'room', label: 'Room Setup/Amenities', icon: 'üõèÔ∏è', description: 'Showing room features' }, { id: 'service', label: 'Service Experience', icon: 'üõéÔ∏è', description: 'Concierge, room service' }, { id: 'dining', label: 'Dining Experience', icon: 'üçΩÔ∏è', description: 'Restaurant, breakfast' }, { id: 'facility', label: 'Facility Tour', icon: 'üèä', description: 'Gym, spa, pool' }], brollRecommendation: { recommended: 'mostly', reason: 'Show luxury and amenities.', percentage: '70% B-Roll' } },
      wellness: { label: 'Wellness/Fitness', locations: { primary: ['Training Room', 'Recovery Room', 'Studio', 'Outdoor Space'], secondary: ['Changing Room', 'Lobby', 'Office'], highlights: ['Training Room (main)', 'Recovery Room (unique)'], featureQuestion: 'What\'s your signature offering?' }, specialtyCategories: { training: { name: 'Training Specialty', options: ['Personal Training', 'Group Fitness Classes', 'Yoga/Pilates', 'CrossFit/Strength', 'Cardio'] }, recovery: { name: 'Recovery & Wellness', options: ['Massage Therapy', 'Sauna/Steam', 'Cold Plunge', 'Stretching Room', 'Meditation'] }, nutrition: { name: 'Nutrition Services', options: ['Nutrition Coaching', 'Meal Planning', 'Smoothie Bar', 'Healthy Cafe'] } }, behindTheScenes: [{ id: 'session', label: 'Client Training', icon: 'üí™', description: 'Active training, form' }, { id: 'transformation', label: 'Results', icon: '‚ú®', description: 'Client wins' }, { id: 'recovery', label: 'Recovery/Self-Care', icon: 'üßò', description: 'Massage, stretching' }, { id: 'equipment', label: 'Equipment Demo', icon: '‚öôÔ∏è', description: 'Using equipment' }, { id: 'nutrition', label: 'Nutrition Talk', icon: 'ü•ó', description: 'Health tips' }, { id: 'community', label: 'Community Dynamic', icon: 'ü§ù', description: 'Group sessions' }], brollRecommendation: { recommended: 'some', reason: 'Show transformation and results.', percentage: '50% B-Roll' } },
      education: { label: 'Education', locations: { primary: ['Classroom', 'Lab/Workshop', 'Studio', 'Office'], secondary: ['Library', 'Outdoor Space', 'Common Area'], highlights: ['Teaching Space', 'Lab Demo Area'], featureQuestion: 'Where does learning happen?' }, behindTheScenes: [{ id: 'lecture', label: 'Teaching', icon: 'üìö', description: 'Active teaching' }, { id: 'hands-on', label: 'Hands-On Demo', icon: 'üî¨', description: 'Practical demo' }, { id: 'student', label: 'Student Engagement', icon: 'üë®‚Äçüéì', description: 'Participation' }, { id: 'project', label: 'Project Work', icon: '‚öíÔ∏è', description: 'Assignments' }, { id: 'qa', label: 'Q&A / Discussion', icon: 'üí¨', description: 'Dialogue' }, { id: 'collaboration', label: 'Collaboration', icon: 'ü§≤', description: 'Group work' }], brollRecommendation: { recommended: 'mostly', reason: 'Let learning in action speak.', percentage: '60-70% B-Roll' } },
      service_based: { label: 'Service-Based', locations: { primary: ['Client Meeting Area', 'Work Station', 'Demo Space'], secondary: ['Office', 'Outdoor', 'Collaboration Space'], highlights: ['Main Service Area'], featureQuestion: 'Where do you deliver service?' }, behindTheScenes: [{ id: 'consultation', label: 'Consultation', icon: 'üíº', description: 'Meeting with clients' }, { id: 'demo', label: 'Service Demo', icon: 'üé¨', description: 'Showing expertise' }, { id: 'results', label: 'Results', icon: '‚ú®', description: 'Client success' }, { id: 'process', label: 'Your Process', icon: '‚öôÔ∏è', description: 'Behind-the-scenes work' }, { id: 'tools', label: 'Tools/Resources', icon: 'üõ†Ô∏è', description: 'What you use' }], brollRecommendation: { recommended: 'some', reason: 'Balance expertise with process.', percentage: '50% B-Roll' } }
    };

    const toneStyles = {
      cynical_witty: { label: 'Cynical & Witty' },
      introspective_poetic: { label: 'Introspective & Poetic' },
      adventurous_bold: { label: 'Adventurous & Bold' },
      nostalgic_warm: { label: 'Nostalgic & Warm' }
    };

    // STATE
    const formState = {
      businessType: '', gender: 'both', locations: [], selectedLocation: '', brollStrategy: '', behindTheScenes: [], wellnessSpecialties: [],
      businessName: '', heroProduct: '', uvpDifferentiation: '', uvpBoundaries: '', uvpEmotion: '', uvpHeritage: '',
      websiteUrl: '', instagramHandle: '', facebookUrl: '', toneStyle: '', ageRange: '', psychographic: '',
      sceneCount: 3, reelLength: 15, currentStep: 1
    };

    let apiKey = localStorage.getItem('perplexityApiKey') || '';

    // API KEY SETUP
    const apiKeyInput = document.getElementById('apiKeyInput');
    const toggleBtn = document.getElementById('toggleApiVisibility');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const apiKeySection = document.getElementById('apiKeySection');

    if (apiKey) { apiKeyInput.value = apiKey; updateApiKeyStatus(); }
    apiKeyInput.addEventListener('input', function() { apiKey = this.value; localStorage.setItem('perplexityApiKey', apiKey); updateApiKeyStatus(); });
    toggleBtn.addEventListener('click', function() { if (apiKeyInput.type === 'password') { apiKeyInput.type = 'text'; toggleBtn.textContent = 'üôà Hide'; } else { apiKeyInput.type = 'password'; toggleBtn.textContent = 'üëÅÔ∏è Show'; } });
    function updateApiKeyStatus() { if (apiKey && apiKey.length > 10) { statusDot.classList.add('valid'); statusText.classList.add('valid'); statusText.textContent = '‚úì API key valid'; apiKeySection.classList.add('valid'); } else { statusDot.classList.remove('valid'); statusText.classList.remove('valid'); statusText.textContent = apiKey ? 'API key too short' : 'No API key entered'; apiKeySection.classList.remove('valid'); } }

    // UI FUNCTIONS
    function updateProgress() {
      const progress = (formState.currentStep / 7) * 100;
      document.getElementById('progressFill').style.width = progress + '%';
      document.querySelectorAll('.progress-step').forEach((step, index) => {
        const stepNum = index + 1;
        step.classList.remove('active', 'completed');
        if (stepNum === formState.currentStep) step.classList.add('active');
        else if (stepNum < formState.currentStep) step.classList.add('completed');
      });
    }

    function showStep(stepNum) {
      document.querySelectorAll('.wizard-step').forEach(step => step.classList.add('hidden'));
      document.getElementById('step' + stepNum).classList.remove('hidden');
      formState.currentStep = stepNum;
      updateProgress();
      updateSidebar();
      syncUIWithFormState();
      window.scrollTo(0, 0);
    }

    function syncUIWithFormState() {
      if (formState.businessType) {
        const card = document.querySelector(`[data-value="${formState.businessType}"]`);
        if (card) {
          document.querySelectorAll('.business-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          card.querySelector('input[name="businessType"]').checked = true;
        }
      }
      document.querySelectorAll('input[name="gender"]').forEach(r => r.checked = r.value === formState.gender);
      document.querySelectorAll('input[name="brollStrategy"]').forEach(r => r.checked = r.value === formState.brollStrategy);
      document.querySelectorAll('input[name="toneStyle"]').forEach(r => r.checked = r.value === formState.toneStyle);
    }

    function updateSidebar() {
      if (formState.businessType) document.getElementById('summaryBusiness').textContent = businessContextMap[formState.businessType].label;
      document.getElementById('summaryGender').textContent = {both: 'Both Genders', women: 'Women-Focused', men: 'Men-Focused'}[formState.gender];
      if (formState.selectedLocation) document.getElementById('summaryLocation').textContent = formState.selectedLocation;
      if (formState.brollStrategy) document.getElementById('summaryBroll').textContent = {all: 'All B-Roll', mostly: 'Mostly B-Roll', some: 'Some B-Roll', none: 'No B-Roll'}[formState.brollStrategy];
      document.getElementById('summaryActivities').textContent = formState.behindTheScenes.length + ' selected';
      if (formState.toneStyle && toneStyles[formState.toneStyle]) document.getElementById('summaryTone').textContent = toneStyles[formState.toneStyle].label;
      document.getElementById('summaryReel').textContent = formState.reelLength + 's';
      updateRecommendations();
    }

    function updateRecommendations() {
      const recommendations = [];
      if (formState.businessType && businessContextMap[formState.businessType]) recommendations.push(`<div class="recommendation-item">üí° B-Roll: ${businessContextMap[formState.businessType].brollRecommendation.percentage}</div>`);
      if (formState.behindTheScenes.length > 0) recommendations.push(`<div class="recommendation-item">üé¨ Activities: ${formState.behindTheScenes.length} selected</div>`);
      if (formState.selectedLocation) recommendations.push(`<div class="recommendation-item">üìç Hero location: ${formState.selectedLocation}</div>`);
      if (formState.toneStyle && toneStyles[formState.toneStyle]) recommendations.push(`<div class="recommendation-item">üé§ Voice: ${toneStyles[formState.toneStyle].label}</div>`);
      recommendations.push(`<div class="recommendation-item">‚è±Ô∏è Duration: ${formState.reelLength}s</div>`);
      document.getElementById('recommendationsList').innerHTML = recommendations.join('');
    }

    // STEP 1: BUSINESS TYPE
    document.getElementById('businessGrid').addEventListener('click', function(e) {
      const card = e.target.closest('.business-card');
      if (!card) return;
      document.querySelectorAll('.business-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      const radio = card.querySelector('input[name="businessType"]');
      radio.checked = true;
      formState.businessType = radio.value;
      updateSidebar();
    });

    document.getElementById('next1').addEventListener('click', () => { if (!formState.businessType) { alert('Please select a business type'); return; } showStep(2); });

    // STEP 2: GENDER
    document.querySelectorAll('input[name="gender"]').forEach(radio => {
      radio.addEventListener('change', function() {
        formState.gender = this.value;
        updateGenderPreview();
        updateSidebar();
      });
    });

    function updateGenderPreview() {
      const info = { both: { title: 'Natural Diversity', description: 'Both men and women in various roles', tip: 'Best for: General appeal' }, women: { title: 'Women-Focused', description: 'Primarily feature women', tip: 'Best for: Women-empowerment brands' }, men: { title: 'Men-Focused', description: 'Primarily feature men', tip: 'Best for: Men-specific services' } }[formState.gender];
      const preview = document.getElementById('genderPreview');
      preview.classList.add('populated');
      preview.innerHTML = `<div class="preview-item"><span class="preview-label">Focus:</span><span class="preview-value">${info.title}</span></div><div class="preview-item"><span class="preview-label">Description:</span><span class="preview-value">${info.description}</span></div><div class="preview-item" style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(102,126,234,0.2);"><span class="preview-label">üí° Tip:</span><span class="preview-value">${info.tip}</span></div>`;
    }

    document.getElementById('next2').addEventListener('click', () => { showStep(3); updateLocationPanel(); });
    document.getElementById('back2').addEventListener('click', () => showStep(1));

    // STEP 3: LOCATIONS
    function updateLocationPanel() {
      const config = businessContextMap[formState.businessType];
      if (!config) return;
      document.getElementById('locationDescription').textContent = config.locations.featureQuestion;
      const primaryContainer = document.getElementById('primaryLocations');
      primaryContainer.innerHTML = '<h3>Primary Locations</h3>';
      const locationGrid = document.createElement('div');
      locationGrid.className = 'location-grid';
      config.locations.primary.forEach(loc => {
        const label = document.createElement('label');
        label.className = 'location-checkbox';
        label.innerHTML = `<input type="checkbox" value="${loc}"><span class="location-label">${loc}</span>`;
        label.querySelector('input').addEventListener('change', function() {
          if (this.checked && formState.selectedLocation === '') { formState.selectedLocation = loc; formState.locations = [loc]; } else if (!this.checked && formState.selectedLocation === loc) { formState.selectedLocation = ''; formState.locations = []; }
          updateLocationPreview();
          updateSidebar();
        });
        locationGrid.appendChild(label);
      });
      primaryContainer.appendChild(locationGrid);

      if (config.locations.secondary && config.locations.secondary.length > 0) {
        const secondaryContainer = document.getElementById('secondaryLocations');
        secondaryContainer.innerHTML = '<h3>Other Areas</h3>';
        const secondaryGrid = document.createElement('div');
        secondaryGrid.className = 'location-grid';
        config.locations.secondary.forEach(loc => {
          const label = document.createElement('label');
          label.className = 'location-checkbox';
          label.innerHTML = `<input type="checkbox" value="${loc}"><span class="location-label">${loc}</span>`;
          label.querySelector('input').addEventListener('change', function() {
            if (this.checked && !formState.locations.includes(loc)) formState.locations.push(loc);
            else if (!this.checked) formState.locations = formState.locations.filter(l => l !== loc);
            updateLocationPreview();
          });
          secondaryGrid.appendChild(label);
        });
        secondaryContainer.appendChild(secondaryGrid);
      }

      const featureQuestion = document.getElementById('featureQuestion');
      featureQuestion.innerHTML = `<p>${config.locations.featureQuestion}</p><div class="feature-options">${config.locations.highlights.map(h => `<button class="feature-btn" data-highlight="${h}">${h}</button>`).join('')}</div>`;
      document.querySelectorAll('.feature-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          document.querySelectorAll('.feature-btn').forEach(b => b.classList.remove('selected'));
          this.classList.add('selected');
          formState.selectedLocation = this.getAttribute('data-highlight').split('(')[0].trim();
          updateLocationPreview();
          updateSidebar();
        });
      });

      if (formState.businessType === 'wellness' && config.specialtyCategories) {
        const specialtiesContainer = document.getElementById('wellnessSpecialties');
        specialtiesContainer.classList.remove('hidden');
        specialtiesContainer.innerHTML = '<h3>Specialty Wellness Areas</h3>';
        for (const [key, category] of Object.entries(config.specialtyCategories)) {
          const categoryDiv = document.createElement('div');
          categoryDiv.className = 'specialty-category';
          categoryDiv.innerHTML = `<h4>${category.name}</h4>`;
          const checkboxesDiv = document.createElement('div');
          checkboxesDiv.className = 'specialty-checkboxes';
          category.options.forEach(option => {
            const label = document.createElement('label');
            label.className = 'specialty-checkbox';
            label.innerHTML = `<input type="checkbox" value="${option}"><span class="specialty-label">${option}</span>`;
            label.querySelector('input').addEventListener('change', function() {
              if (this.checked && !formState.wellnessSpecialties.includes(option)) formState.wellnessSpecialties.push(option);
              else if (!this.checked) formState.wellnessSpecialties = formState.wellnessSpecialties.filter(s => s !== option);
            });
            checkboxesDiv.appendChild(label);
          });
          categoryDiv.appendChild(checkboxesDiv);
          specialtiesContainer.appendChild(categoryDiv);
        }
      } else if (formState.businessType !== 'wellness') {
        document.getElementById('wellnessSpecialties').classList.add('hidden');
      }

      updateLocationPreview();
    }

    function updateLocationPreview() {
      const preview = document.getElementById('locationPreview');
      if (formState.locations.length > 0) {
        preview.classList.add('populated');
        preview.innerHTML = `<div class="preview-item"><span class="preview-label">Selected:</span><span class="preview-value">${formState.locations.join(', ')}</span></div><div class="preview-item"><span class="preview-label">Hero:</span><span class="preview-value">${formState.selectedLocation || 'Not selected'}</span></div>`;
      } else {
        preview.classList.remove('populated');
        preview.innerHTML = '<p>Select locations to see preview</p>';
      }
    }

    document.getElementById('next3').addEventListener('click', () => { if (formState.selectedLocation === '') { alert('Please select a primary location'); return; } showStep(4); updateBrollPanel(); });
    document.getElementById('back3').addEventListener('click', () => showStep(2));

    // STEP 4: B-ROLL
    function updateBrollPanel() {
      const config = businessContextMap[formState.businessType];
      const rec = config.brollRecommendation;
      document.getElementById('brollRecommendation').innerHTML = `<div class="recommendation-content"><p><strong>‚ú® Recommended:</strong> ${rec.recommended.toUpperCase()}</p><p>${rec.reason}</p><p><strong>Suggested ratio:</strong> ${rec.percentage}</p></div>`;
      document.querySelectorAll('.broll-card').forEach(card => {
        card.classList.remove('recommended');
        const radio = card.querySelector('input[name="brollStrategy"]');
        if (radio && radio.value === rec.recommended) card.classList.add('recommended');
      });
    }

    document.querySelectorAll('input[name="brollStrategy"]').forEach(radio => {
      radio.addEventListener('change', function() {
        formState.brollStrategy = this.value;
        const preview = document.getElementById('brollPreview');
        preview.classList.add('populated');
        preview.innerHTML = `<div class="preview-item"><span class="preview-label">Strategy:</span><span class="preview-value">${this.closest('.broll-card').querySelector('.broll-title').textContent}</span></div>`;
        updateSidebar();
      });
    });

    document.getElementById('next4').addEventListener('click', () => { if (!formState.brollStrategy) { alert('Please select B-roll strategy'); return; } showStep(5); updateBehindTheScenesPanel(); });
    document.getElementById('back4').addEventListener('click', () => showStep(3));

    // STEP 5: BTS
    function updateBehindTheScenesPanel() {
      const config = businessContextMap[formState.businessType];
      const container = document.getElementById('btsActivities');
      container.innerHTML = '';
      config.behindTheScenes.forEach(activity => {
        const label = document.createElement('label');
        label.className = 'bts-checkbox';
        label.innerHTML = `<input type="checkbox" value="${activity.id}"><div class="bts-label"><span class="bts-icon">${activity.icon}</span><div class="bts-title">${activity.label}</div><div class="bts-desc">${activity.description}</div></div>`;
        label.querySelector('input').addEventListener('change', function() {
          if (this.checked) formState.behindTheScenes.push(activity.id);
          else formState.behindTheScenes = formState.behindTheScenes.filter(id => id !== activity.id);
          const preview = document.getElementById('btsPreview');
          if (formState.behindTheScenes.length > 0) {
            preview.classList.add('populated');
            preview.innerHTML = `<div class="preview-item"><span class="preview-label">Activities:</span><span class="preview-value">${formState.behindTheScenes.length} selected</span></div>`;
          }
          updateSidebar();
        });
        container.appendChild(label);
      });
    }

    document.getElementById('next5').addEventListener('click', () => { if (formState.behindTheScenes.length === 0) { alert('Select at least one activity'); return; } showStep(6); });
    document.getElementById('back5').addEventListener('click', () => showStep(4));

    // STEP 6: BRAND & VOICE
    document.getElementById('businessName').addEventListener('input', function() { formState.businessName = this.value; updateSidebar(); });
    document.getElementById('heroProduct').addEventListener('input', function() { formState.heroProduct = this.value; });
    document.getElementById('uvpDifferentiation').addEventListener('input', function() { formState.uvpDifferentiation = this.value; });
    document.getElementById('uvpBoundaries').addEventListener('input', function() { formState.uvpBoundaries = this.value; });
    document.getElementById('uvpEmotion').addEventListener('input', function() { formState.uvpEmotion = this.value; });
    document.getElementById('uvpHeritage').addEventListener('input', function() { formState.uvpHeritage = this.value; });
    document.getElementById('websiteUrl').addEventListener('input', function() { formState.websiteUrl = this.value; });
    document.getElementById('instagramHandle').addEventListener('input', function() { formState.instagramHandle = this.value; });
    document.getElementById('facebookUrl').addEventListener('input', function() { formState.facebookUrl = this.value; });

    document.querySelectorAll('input[name="toneStyle"]').forEach(radio => {
      radio.addEventListener('change', function() {
        formState.toneStyle = this.value;
        document.querySelectorAll('.tone-card').forEach(card => card.classList.remove('selected'));
        this.closest('.tone-card').classList.add('selected');
        updateSidebar();
      });
    });

    document.getElementById('ageRange').addEventListener('change', function() { formState.ageRange = this.value; });
    document.getElementById('psychographic').addEventListener('change', function() { formState.psychographic = this.value; });

    document.getElementById('next6').addEventListener('click', () => { if (!formState.businessName) { alert('Enter business name'); return; } if (!formState.toneStyle) { alert('Select voice style'); return; } showStep(7); populateReviewPanel(); });
    document.getElementById('back6').addEventListener('click', () => showStep(5));

    // STEP 7: REEL LENGTH & GENERATION
    document.querySelectorAll('input[name="reelLength"]').forEach(radio => {
      radio.addEventListener('change', function() {
        formState.reelLength = this.value;
        const customContainer = document.getElementById('customReelContainer');
        if (this.value === 'custom') {
          customContainer.style.display = 'block';
          document.getElementById('customReelLength').focus();
        } else {
          customContainer.style.display = 'none';
          formState.reelLength = parseInt(this.value);
        }
        updateSidebar();
      });
    });

    document.getElementById('customReelLength').addEventListener('input', function() {
      if (this.value) formState.reelLength = parseInt(this.value);
      updateSidebar();
    });

    document.getElementById('sceneCount').addEventListener('change', function() { formState.sceneCount = parseInt(this.value); });

    function populateReviewPanel() {
      document.getElementById('reviewBrief').innerHTML = `<div class="review-item"><div class="review-item-label">Business</div><div class="review-item-value">${businessContextMap[formState.businessType].label}</div></div><div class="review-item"><div class="review-item-label">Gender</div><div class="review-item-value">${{both: 'Both', women: 'Women', men: 'Men'}[formState.gender]}</div></div><div class="review-item"><div class="review-item-label">Locations</div><div class="review-item-value">${formState.locations.join(', ')}</div></div><div class="review-item"><div class="review-item-label">B-Roll</div><div class="review-item-value">${{all: 'All', mostly: 'Mostly', some: 'Some', none: 'None'}[formState.brollStrategy]}</div></div><div class="review-item"><div class="review-item-label">Activities</div><div class="review-item-value">${formState.behindTheScenes.length} selected</div></div>`;
      document.getElementById('reviewBrand').innerHTML = `<div class="review-item"><div class="review-item-label">Business</div><div class="review-item-value">${formState.businessName}</div></div><div class="review-item"><div class="review-item-label">Hero</div><div class="review-item-value">${formState.heroProduct || 'N/A'}</div></div><div class="review-item"><div class="review-item-label">Voice</div><div class="review-item-value">${toneStyles[formState.toneStyle].label}</div></div><div class="review-item"><div class="review-item-label">Age</div><div class="review-item-value">${formState.ageRange || 'All'}</div></div><div class="review-item"><div class="review-item-label">Audience</div><div class="review-item-value">${formState.psychographic || 'General'}</div></div>`;
    }

    document.getElementById('back7').addEventListener('click', () => showStep(6));

    document.getElementById('generateStoryboard').addEventListener('click', async () => {
      if (!apiKey || apiKey.length < 10) { alert('‚ö†Ô∏è Enter your API key'); return; }
      const btn = document.getElementById('generateStoryboard');
      const originalText = btn.textContent;
      btn.textContent = '‚è≥ Generating...';
      btn.disabled = true;
      try {
        const shotTypeGuide = `For EACH SCENE, generate a per-scene [SHOT LIST] that includes these specific details for EVERY shot:
- Shot type: (Close-up / Medium / Wide / Ultra-Wide / Detail / Over-the-Shoulder)
- Camera move: (Static / Slow Pan / Slow Push-in / Handheld Walk / Tilt)
- Angle: (Eye level / High angle / Low angle)
- Duration: (3-5 seconds recommended)
- Subject: (Exact description of what to film)
- Label: (A-Roll for talking head, B-Roll for supporting visuals)

Group each [SCENE N SHOT LIST] immediately after [SCENE N VO].`;

        const reelTiming = formState.reelLength === 'custom' ? parseInt(document.getElementById('customReelLength').value) : parseInt(formState.reelLength);
        
        const prompt = `Generate a COMPLETE PRODUCTION PLAN for: ${formState.businessName} (${businessContextMap[formState.businessType].label}). 
Hero: ${formState.heroProduct}. 
Locations: ${formState.locations.join(', ')}. 
UVP: ${formState.uvpDifferentiation}. 
Voice: ${toneStyles[formState.toneStyle].label}. 
Create ${formState.sceneCount} scenes. 
TARGET DURATION: ${reelTiming} seconds - adjust VO length and shot counts accordingly.

${shotTypeGuide}

Output structure:
[HERO INTRO HOOK] (2-3 sentences max)
[SCENE 1 VO] (2-4 sentences)
[SCENE 1 SHOT LIST] with 4-6 shots, each with shot type, move, angle, duration, subject, label
[SCENE 2 VO] (2-4 sentences)
[SCENE 2 SHOT LIST] with 4-6 shots, each with shot type, move, angle, duration, subject, label
... repeat for all scenes ...
[FINAL CTA VO] (1-2 sentences)
[EQUIPMENT CHECKLIST] - what camera gear is needed
[TIMING GUIDE] - total usable footage needed for ${reelTiming}s reel
[SHOT SUFFICIENCY CHECK] - confirm user has enough shots to edit`;

        const response = await fetch('https://api.perplexity.ai/chat/completions', { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` }, body: JSON.stringify({ model: 'sonar', messages: [{ role: 'user', content: prompt }], max_tokens: 6000 }) });
        if (!response.ok) throw new Error('API error');
        const data = await response.json();
        const storyboard = data.choices[0].message.content;
        const htmlContent = `<!DOCTYPE html><html><head><title>${formState.businessName} Production Plan</title><style>body{margin:0;padding:0.5in;font-family:'Courier New',monospace;font-size:11px;line-height:1.5;color:#333;background:#fff}@page{size:8.5in 11in;margin:0.5in}*{box-sizing:border-box}h1{font-size:18px;margin:0 0 10px 0;text-align:center;border-bottom:2px solid #333;padding-bottom:5px}h2{font-size:14px;margin:15px 0 8px 0;font-weight:bold;border-bottom:1px solid #999;padding-bottom:3px}h3{font-size:12px;margin:10px 0 5px 0;font-weight:bold}p,div{margin:0 0 5px 0}pre{white-space:pre-wrap;word-wrap:break-word;margin:0;font-size:10px}button{padding:8px 16px;background:#333;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin:10px 5px 0 0}button:hover{background:#555}@media print{body{background:#f5f5f5}button{display:none}.no-print{display:none}}</style></head><body><h1>üé¨ ${formState.businessName}</h1><h2>Production Plan | ${reelTiming} Seconds</h2><pre>${storyboard}</pre><div class="no-print" style="margin-top:20px;text-align:center"><button onclick="window.print()">üìÑ Print</button><button onclick="navigator.clipboard.writeText(document.querySelector('pre').textContent)">üìã Copy</button><button onclick="window.close()">‚úï Close</button></div></body></html>`;
        const resultWindow = window.open('', '_blank', 'width=750,height=900');
        if (resultWindow) { resultWindow.document.write(htmlContent); resultWindow.document.close(); } else alert('Pop-up blocked');
      } catch (error) {
        alert('Error: ' + error.message);
      }
      btn.textContent = originalText;
      btn.disabled = false;
    });

    updateGenderPreview();
    updateSidebar();
  </script>
</body>
</html>