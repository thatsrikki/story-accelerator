<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentic Story Accelerator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --color-teal-500: rgba(33, 128, 141, 1);
            --color-teal-600: rgba(29, 116, 128, 1);
            --color-teal-700: rgba(26, 104, 115, 1);
            --color-cream-50: rgba(252, 252, 249, 1);
            --color-cream-100: rgba(255, 255, 253, 1);
            --color-slate-900: rgba(19, 52, 59, 1);
            --color-slate-500: rgba(98, 108, 113, 1);
            --color-red-500: rgba(192, 21, 47, 1);
            --color-charcoal-700: rgba(31, 33, 33, 1);
            --color-charcoal-800: rgba(38, 40, 40, 1);
            --color-gray-200: rgba(245, 245, 245, 1);
            --color-gray-300: rgba(167, 169, 169, 1);
            --color-background: var(--color-cream-50);
            --color-surface: var(--color-cream-100);
            --color-text: var(--color-slate-900);
            --color-text-secondary: var(--color-slate-500);
            --color-primary: var(--color-teal-500);
            --color-primary-hover: var(--color-teal-600);
            --color-border: rgba(94, 82, 64, 0.2);
            --color-error: var(--color-red-500);
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --color-background: var(--color-charcoal-700);
                --color-surface: var(--color-charcoal-800);
                --color-text: var(--color-gray-200);
                --color-text-secondary: var(--color-gray-300);
                --color-border: rgba(119, 124, 124, 0.3);
            }
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; font-size: 14px; line-height: 1.6; color: var(--color-text); background-color: var(--color-background); padding: 24px; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { text-align: center; margin-bottom: 32px; }
        h1 { font-size: 24px; font-weight: 600; margin-bottom: 8px; }
        .subtitle { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 24px; }
        .progress-bar { display: flex; justify-content: center; gap: 16px; margin-top: 24px; }
        .progress-step { width: 40px; height: 40px; border-radius: 50%; background-color: var(--color-surface); border: 2px solid var(--color-border); display: flex; align-items: center; justify-content: center; font-weight: 600; color: var(--color-text-secondary); transition: all 0.3s ease; }
        .progress-step.active { background-color: var(--color-primary); border-color: var(--color-primary); color: white; }
        .progress-step.completed { background-color: var(--color-teal-700); border-color: var(--color-teal-700); color: white; }
        .phase { display: none; background-color: var(--color-surface); border-radius: 12px; padding: 32px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 24px; }
        .phase.active { display: block; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .phase-title { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
        .phase-description { font-size: 14px; color: var(--color-text-secondary); margin-bottom: 24px; }
        .form-group { margin-bottom: 24px; }
        label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .required { color: var(--color-error); }
        input, select, textarea { width: 100%; min-height: 44px; padding: 12px; font-size: 14px; font-family: inherit; color: var(--color-text); background-color: var(--color-background); border: 1px solid var(--color-border); border-radius: 8px; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: var(--color-primary); box-shadow: 0 0 0 3px rgba(33, 128, 141, 0.1); }
        input[readonly], textarea[readonly] { background-color: var(--color-surface); cursor: not-allowed; opacity: 0.7; }
        .help-text { font-size: 12px; color: var(--color-text-secondary); font-style: italic; margin-top: 4px; }
        .note { font-size: 12px; color: var(--color-text-secondary); margin-top: 4px; padding: 8px; background-color: rgba(33, 128, 141, 0.05); border-radius: 6px; }
        .btn-primary, .btn-secondary { min-height: 44px; padding: 12px 24px; font-size: 14px; font-weight: 500; border-radius: 8px; border: none; cursor: pointer; transition: all 0.2s ease; }
        .btn-primary { background-color: var(--color-primary); color: white; }
        .btn-primary:hover:not(:disabled) { background-color: var(--color-primary-hover); }
        .btn-primary:disabled { background-color: var(--color-border); cursor: not-allowed; opacity: 0.6; }
        .btn-secondary { background-color: transparent; color: var(--color-primary); border: 1px solid var(--color-primary); }
        .btn-secondary:hover { background-color: rgba(33, 128, 141, 0.1); }
        .navigation { display: flex; justify-content: space-between; gap: 16px; margin-top: 32px; }
        .hidden { display: none !important; }
        #loadingSpinner { text-align: center; padding: 24px; color: var(--color-text-secondary); }
        .scene-block { background-color: var(--color-background); border-left: 4px solid var(--color-primary); padding: 20px; margin-bottom: 24px; border-radius: 8px; }
        .scene-title { font-size: 16px; font-weight: 600; color: var(--color-primary); margin-bottom: 12px; }
        .scene-meta { font-size: 12px; color: var(--color-text-secondary); margin-bottom: 16px; }
        .scene-section { margin-bottom: 16px; }
        .scene-section-label { font-size: 12px; font-weight: 600; color: var(--color-text-secondary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .scene-section-content { font-size: 13px; line-height: 1.7; color: var(--color-text); }
        .shots-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 12px; margin-top: 12px; }
        .shot-card { background-color: var(--color-surface); border: 2px solid var(--color-primary); border-radius: 8px; padding: 12px; display: flex; flex-direction: column; }
        .shot-card-number { font-size: 11px; font-weight: 600; color: var(--color-primary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
        .shot-card-label { font-size: 12px; font-weight: 600; color: var(--color-text); margin-bottom: 8px; }
        .shot-card-content { font-size: 11px; line-height: 1.5; color: var(--color-text-secondary); }
        .shot-card-item { margin-bottom: 6px; }
        .shot-card-item-label { font-weight: 600; color: var(--color-text); font-size: 10px; }
        .shot-card-item-value { color: var(--color-text-secondary); margin-top: 2px; }
        .action-buttons { display: flex; gap: 16px; margin-top: 24px; }
        @media (max-width: 1024px) {
            .shots-grid { grid-template-columns: repeat(3, 1fr); }
        }
        @media (max-width: 768px) {
            body { padding: 16px; }
            .phase { padding: 24px; }
            .navigation { flex-direction: column; }
            .navigation button { width: 100%; }
            .shots-grid { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 480px) {
            .shots-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Authentic Story Accelerator</h1>
            <p class="subtitle">Generate Bourdain-Style Storyboards for Your Business in Under 5 Minutes</p>
            <div class="progress-bar">
                <div class="progress-step active" data-phase="1">1</div>
                <div class="progress-step" data-phase="2">2</div>
                <div class="progress-step" data-phase="3">3</div>
                <div class="progress-step" data-phase="4">4</div>
            </div>
        </header>

        <div id="phase1" class="phase active">
            <h2 class="phase-title">Phase 1: Business Setup</h2>
            <p class="phase-description">Define your business type and reel objectives with Bourdain-style authenticity</p>
            
            <div class="form-group">
                <label>Business/Service Type <span class="required">*</span></label>
                <select id="businessType" required>
                    <option value="">Select your business type...</option>
                    <option value="food">Food & Beverage (Restaurant, Bar, CafÃ©)</option>
                    <option value="fitness">Wellness/Fitness (Gym, Yoga, Personal Training)</option>
                    <option value="travel">Travel/Adventure (Tours, Hotels, Experiences)</option>
                    <option value="retail">Retail/Products (Boutique, E-commerce)</option>
                    <option value="services">Professional Services (Consulting, Coaching)</option>
                    <option value="creative">Creative/Entertainment (Art Studio, Events)</option>
                </select>
                <p class="help-text">This anchors your reel's theme - transforms generic promo into a "Bourdain dispatch"</p>
            </div>

            <div class="form-group">
                <label>Reel Objective (Message Type) <span class="required">*</span></label>
                <select id="reelObjective" required>
                    <option value="">Select your objective...</option>
                    <option value="awareness">Awareness/Brand Intro ("Discover the soul")</option>
                    <option value="promotion">Promotion/Sale ("Taste the deal before it's gone")</option>
                    <option value="booking">Booking/Engagement ("Join the ritual tonight")</option>
                    <option value="testimonial">Testimonial/Story ("One bite changed everything")</option>
                    <option value="educational">Educational/Behind-the-Scenes ("The grind you don't see")</option>
                </select>
                <p class="help-text">Defines your call-to-action and emotional arc</p>
            </div>

            <div class="form-group">
                <label>Target Audience Profile <span class="required">*</span></label>
                <select id="targetAudience" required>
                    <option value="">Select your audience...</option>
                    <option value="rebels">18-24: Rebels (High-energy, bold, unfiltered)</option>
                    <option value="hustlers">25-40: Urban Hustlers (Busy, seeking authentic escapes)</option>
                    <option value="seekers">41+: Seasoned Seekers (Refined, nostalgic, quality-focused)</option>
                </select>
                <p class="help-text">Tailors language and pacing to resonate with your audience</p>
            </div>

            <div class="form-group">
                <label>Tone Intensity (Bourdain Flavor) <span class="required">*</span></label>
                <select id="toneIntensity" required>
                    <option value="">Select tone...</option>
                    <option value="cynical">Cynical & Witty (Dry humor, street-smart digs)</option>
                    <option value="poetic">Introspective & Poetic (Deep musings, sensory metaphors)</option>
                    <option value="bold">Adventurous & Bold (High-energy rants, dare-you challenges)</option>
                    <option value="warm">Nostalgic & Warm (Subtle sentiment under sarcasm)</option>
                </select>
                <p class="help-text">Adjusts VO phrasing and shot rhythm to match your brand</p>
            </div>

            <div class="form-group">
                <label>Reel Length <span class="required">*</span></label>
                <select id="reelLength" required>
                    <option value="">Select duration...</option>
                    <option value="15">15 seconds (Teaser - 3 scenes)</option>
                    <option value="30">30 seconds (Standard - 4 scenes)</option>
                    <option value="60">60 seconds (Deep Dive - 5 scenes)</option>
                </select>
                <p class="help-text">Determines scene count and pacing</p>
            </div>

            <div class="form-group">
                <label>Hero Product/Service <span class="required">*</span></label>
                <input type="text" id="heroProduct" placeholder="e.g., Kufta Kebab dinner specials, HIIT workout class" required>
                <p class="help-text">The star of your reel - what gets the macro reveal</p>
            </div>

            <div class="form-group">
                <label>Location/Setting <span class="required">*</span></label>
                <select id="locationSetting" required>
                    <option value="">Select setting...</option>
                    <option value="indoor">Indoor (Studio, Kitchen, Interior)</option>
                    <option value="outdoor">Outdoor (Street, Urban, Nature)</option>
                    <option value="hybrid">Hybrid (Mix of both)</option>
                </select>
                <p class="help-text">Defines visual environment and lighting style</p>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="loadExample()">Load Example</button>
                <button class="btn-primary" onclick="nextPhase()">Next</button>
            </div>
        </div>

        <div id="phase2" class="phase">
            <h2 class="phase-title">Phase 2: Business Details</h2>
            <p class="phase-description">Provide specific details for AI-powered story generation</p>
            
            <div class="form-group">
                <label>Business Name <span class="required">*</span></label>
                <input type="text" id="businessName" placeholder="Your business name" required>
            </div>

            <div class="form-group">
                <label>Location <span class="required">*</span></label>
                <input type="text" id="location" placeholder="City, neighborhood, or address" required>
                <p class="help-text">Be specific - helps AI create authentic local flavor</p>
            </div>

            <div class="form-group">
                <label>Website</label>
                <input type="url" id="website" placeholder="https://yourwebsite.com">
            </div>

            <div class="form-group">
                <label>Unique Value Proposition <span class="required">*</span></label>
                <textarea id="uniqueValue" rows="4" placeholder="What makes you different? What's your secret sauce?" required></textarea>
                <p class="help-text">This is the heart of your story - be specific and authentic</p>
            </div>

            <div class="form-group">
                <label>Current Specials/Offers</label>
                <textarea id="specials" rows="3" placeholder="Any promotions, seasonal items, or limited-time offers?"></textarea>
            </div>

            <div class="form-group">
                <label>Perplexity API Key <span class="required">*</span></label>
                <input type="password" id="apiKey" placeholder="pplx-xxxxxxxxxxxxx" required>
                <p class="help-text">Get your API key from <a href="https://www.perplexity.ai/settings/api" target="_blank" rel="noopener noreferrer">https://www.perplexity.ai/settings/api</a></p>
                <p class="note">ðŸ”’ Your API key is stored only in your browser session, never saved</p>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="previousPhase()">Previous</button>
                <button class="btn-primary" onclick="nextPhase()">Next</button>
            </div>
        </div>

        <div id="phase3" class="phase">
            <h2 class="phase-title">Phase 3: AI Story Generation</h2>
            <p class="phase-description">Generate your Bourdain-style narrative with AI</p>
            
            <button class="btn-primary" id="generateBtn" onclick="generateStory()" style="width: 100%; margin-bottom: 24px;">Generate Story with AI</button>
            
            <div id="loadingSpinner" class="hidden">
                <p style="font-size: 16px; margin-bottom: 12px;">ðŸŽ¬ Generating your story...</p>
                <p style="font-size: 12px; margin-top: 16px; font-style: italic;">This typically takes 10-30 seconds</p>
            </div>

            <div id="errorMessage" class="hidden" style="padding: 12px; background-color: rgba(192, 21, 47, 0.1); border-radius: 8px; margin-top: 16px;"></div>
            
            <div id="generatedContent" class="hidden">
                <div class="form-group">
                    <label>Title Hook</label>
                    <input type="text" id="titleHook" readonly>
                </div>
                <div class="form-group">
                    <label>Scene 1 VO</label>
                    <textarea id="scene1VO" rows="4" readonly></textarea>
                </div>
                <div class="form-group">
                    <label>Scene 2 VO</label>
                    <textarea id="scene2VO" rows="4" readonly></textarea>
                </div>
                <div class="form-group">
                    <label>Scene 3 VO</label>
                    <textarea id="scene3VO" rows="4" readonly></textarea>
                </div>
                <div class="form-group" id="scene4Group" style="display: none;">
                    <label>Scene 4 VO</label>
                    <textarea id="scene4VO" rows="4" readonly></textarea>
                </div>
                <div class="form-group" id="scene5Group" style="display: none;">
                    <label>Scene 5 VO</label>
                    <textarea id="scene5VO" rows="4" readonly></textarea>
                </div>
            </div>

            <div class="navigation">
                <button class="btn-secondary" onclick="previousPhase()">Previous</button>
                <button class="btn-primary" id="nextBtn3" onclick="nextPhase()" disabled>Next</button>
            </div>
        </div>

        <div id="phase4" class="phase">
            <h2 class="phase-title">Phase 4: Your Production-Ready Storyboard</h2>
            <p class="phase-description">Detailed shot breakdown - exactly what to film and how to capture it</p>
            
            <div id="storyboardContainer"></div>

            <div class="action-buttons">
                <button class="btn-secondary" onclick="editInputs()">Edit Inputs</button>
                <button class="btn-primary" onclick="exportPDF()">Export as PDF</button>
            </div>
        </div>
    </div>

    <script>
        let currentPhase = 1;
        let appData = { scenes: [], heroProduct: '', businessName: '', shotDetails: [] };

        function nextPhase() {
            if (currentPhase < 4) {
                document.getElementById('phase' + currentPhase).classList.remove('active');
                currentPhase++;
                document.getElementById('phase' + currentPhase).classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
                if (currentPhase === 4) buildStoryboard();
            }
        }

        function previousPhase() {
            if (currentPhase > 1) {
                document.getElementById('phase' + currentPhase).classList.remove('active');
                currentPhase--;
                document.getElementById('phase' + currentPhase).classList.add('active');
                updateProgress();
                window.scrollTo(0, 0);
            }
        }

        function updateProgress() {
            document.querySelectorAll('.progress-step').forEach((s, i) => {
                s.classList.remove('active', 'completed');
                if (i + 1 === currentPhase) s.classList.add('active');
                else if (i + 1 < currentPhase) s.classList.add('completed');
            });
        }

        async function generateStory() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                showError('Please enter your API key');
                return;
            }

            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loadingSpinner').classList.remove('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            const sceneCount = document.getElementById('reelLength').value === '15' ? 3 : 
                               document.getElementById('reelLength').value === '30' ? 4 : 5;
            document.getElementById('scene4Group').style.display = sceneCount >= 4 ? 'block' : 'none';
            document.getElementById('scene5Group').style.display = sceneCount >= 5 ? 'block' : 'none';

            const formData = {
                businessType: document.getElementById('businessType').options[document.getElementById('businessType').selectedIndex].text,
                reelObjective: document.getElementById('reelObjective').options[document.getElementById('reelObjective').selectedIndex].text,
                targetAudience: document.getElementById('targetAudience').options[document.getElementById('targetAudience').selectedIndex].text,
                toneIntensity: document.getElementById('toneIntensity').options[document.getElementById('toneIntensity').selectedIndex].text,
                heroProduct: document.getElementById('heroProduct').value,
                businessName: document.getElementById('businessName').value,
                location: document.getElementById('location').value,
                uniqueValue: document.getElementById('uniqueValue').value,
                specials: document.getElementById('specials').value || 'None'
            };

            appData.heroProduct = formData.heroProduct;
            appData.businessName = formData.businessName;

            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + apiKey,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'sonar-pro',
                        messages: [{
                            role: 'system',
                            content: 'You are an expert video storyboard writer specializing in Anthony Bourdain-style narrative. Create gritty, introspective, sensory-driven voiceover scripts with raw honesty, poetic cynicism, and confessional intimacy.'
                        }, {
                            role: 'user',
                            content: `Create a ${sceneCount}-scene storyboard for ${formData.businessName}, a ${formData.businessType} business in ${formData.location}.

Business Details:
- Hero Product: ${formData.heroProduct}
- Unique Value: ${formData.uniqueValue}
- Current Specials: ${formData.specials}
- Target Audience: ${formData.targetAudience}
- Tone: ${formData.toneIntensity}
- Objective: ${formData.reelObjective}

Generate EXACTLY this format:
TITLE: [compelling hook]
SCENE 1 VO: [80 words]
SCENE 2 VO: [80 words]
SCENE 3 VO: [80 words]
${sceneCount >= 4 ? 'SCENE 4 VO: [80 words]' : ''}
${sceneCount >= 5 ? 'SCENE 5 VO: [80 words]' : ''}

Use sensory language, cynical wit, authentic voice.`
                        }],
                        max_tokens: 2000
                    })
                });

                if (!response.ok) throw new Error('API error: ' + response.status);
                
                const data = await response.json();
                const text = data.choices[0].message.content;

                document.getElementById('titleHook').value = (text.match(/TITLE:\s*(.+)/)?.[1] || '').trim();
                document.getElementById('scene1VO').value = (text.match(/SCENE 1 VO:\s*(.+?)(?=SCENE 2|$)/s)?.[1] || '').trim();
                document.getElementById('scene2VO').value = (text.match(/SCENE 2 VO:\s*(.+?)(?=SCENE 3|$)/s)?.[1] || '').trim();
                document.getElementById('scene3VO').value = (text.match(/SCENE 3 VO:\s*(.+?)(?=SCENE 4|$)/s)?.[1] || '').trim();
                if (sceneCount >= 4) document.getElementById('scene4VO').value = (text.match(/SCENE 4 VO:\s*(.+?)(?=SCENE 5|$)/s)?.[1] || '').trim();
                if (sceneCount >= 5) document.getElementById('scene5VO').value = (text.match(/SCENE 5 VO:\s*(.+)/s)?.[1] || '').trim();

                appData.scenes = [];
                for (let i = 1; i <= sceneCount; i++) {
                    appData.scenes.push({
                        vo: document.getElementById('scene' + i + 'VO').value,
                        num: i
                    });
                }

                document.getElementById('generatedContent').classList.remove('hidden');
                document.getElementById('nextBtn3').disabled = false;

            } catch (error) {
                showError(error.message);
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loadingSpinner').classList.add('hidden');
            }
        }

        function showError(msg) {
            document.getElementById('errorMessage').textContent = 'âš ï¸ ' + msg;
            document.getElementById('errorMessage').classList.remove('hidden');
        }

        function extractShotsFromVO(vo, sceneNum, heroProduct) {
            const voLower = vo.toLowerCase();
            const words = vo.split(' ');
            
            const shots = [
                {
                    num: 1,
                    label: extractFirstConcept(vo),
                    extract: extractFirstThirdVO(vo),
                    focal: 'Opening context and ' + heroProduct,
                    where: 'Business entrance or first visible area',
                    action: 'Introduce the setting',
                    details: 'First impression, authenticity, atmosphere, signage',
                    broll: 'Wide establishing exterior/interior shots'
                },
                {
                    num: 2,
                    label: extractSecondConcept(vo),
                    extract: extractSecondThirdVO(vo),
                    focal: heroProduct + ' becoming visible',
                    where: 'Transition area, approach to counter/main area',
                    action: 'Build anticipation moving toward hero product',
                    details: 'Sensory moments - heat, aroma, sound, anticipation',
                    broll: 'Medium shots of approach, doorway, counter visibility'
                },
                {
                    num: 3,
                    label: extractThirdConcept(vo),
                    extract: 'Environment and setting details',
                    focal: heroProduct + ' in its natural environment',
                    where: 'Main workspace - kitchen, counter, or service area',
                    action: 'Show the space and team in action',
                    details: 'Team work, tools, preparation, authenticity, environment',
                    broll: 'Wide shots of kitchen/workspace, people, activity'
                },
                {
                    num: 4,
                    label: 'The Detail Shot',
                    extract: extractQualityLanguage(vo),
                    focal: 'EXTREME CLOSE-UP of ' + heroProduct,
                    where: 'Macro detail zone - grill, plating, hand, or product',
                    action: 'Reveal quality and craftsmanship with macro focus',
                    details: extractSensoryDetails(vo),
                    broll: 'Macro/detail shots, extreme close-ups, texture focus'
                },
                {
                    num: 5,
                    label: extractFinalConcept(vo),
                    extract: extractFinalThirdVO(vo),
                    focal: 'Genuine human reaction or completion',
                    where: 'Natural setting - eating, enjoying, reacting',
                    action: 'Capture authentic moment and satisfaction',
                    details: 'Real emotion, satisfaction, fulfillment, payoff',
                    broll: 'Customer reactions, celebration, owner pride, legacy'
                }
            ];

            return shots;
        }

        function extractFirstConcept(vo) {
            const sentences = vo.split(/[.!?]/);
            if (sentences[0]) {
                const words = sentences[0].split(' ');
                return words.slice(0, 5).join(' ').trim();
            }
            return 'Opening Hook';
        }

        function extractSecondConcept(vo) {
            const sentences = vo.split(/[.!?]/);
            if (sentences[1]) {
                const words = sentences[1].trim().split(' ');
                return words.slice(0, 5).join(' ').trim();
            }
            return 'Building Moment';
        }

        function extractThirdConcept(vo) {
            const midPoint = Math.floor(vo.length / 2);
            const midSection = vo.substring(midPoint, midPoint + 100);
            const words = midSection.split(' ').slice(0, 4);
            return words.join(' ').trim() || 'Context Reveal';
        }

        function extractFinalConcept(vo) {
            const sentences = vo.split(/[.!?]/).filter(s => s.trim());
            const lastSentence = sentences[sentences.length - 1];
            if (lastSentence) {
                const words = lastSentence.trim().split(' ').slice(0, 4);
                return words.join(' ').trim();
            }
            return 'Final Payoff';
        }

        function extractFirstThirdVO(vo) {
            const length = Math.floor(vo.length / 3);
            return vo.substring(0, length).trim() + '...';
        }

        function extractSecondThirdVO(vo) {
            const start = Math.floor(vo.length / 3);
            const end = Math.floor(vo.length * 2 / 3);
            return vo.substring(start, end).trim() + '...';
        }

        function extractFinalThirdVO(vo) {
            const start = Math.floor(vo.length * 2 / 3);
            return '...' + vo.substring(start).trim();
        }

        function extractQualityLanguage(vo) {
            const qualityWords = ['char', 'crisp', 'sizzle', 'flame', 'grill', 'steam', 'smoke', 'texture', 'color', 'fresh', 'bite', 'taste', 'flavor', 'juicy', 'tender'];
            for (let word of qualityWords) {
                if (vo.toLowerCase().includes(word)) {
                    return 'Close-up capturing ' + word + ' and texture details';
                }
            }
            return 'Macro close-up revealing product quality and detail';
        }

        function extractSensoryDetails(vo) {
            const sensoryTerms = ['char', 'smoke', 'heat', 'flame', 'sizzle', 'aroma', 'steam', 'texture', 'glisten', 'moisture'];
            let details = 'Visible quality details';
            for (let term of sensoryTerms) {
                if (vo.toLowerCase().includes(term)) {
                    details += ' - ' + term + ' visible';
                    break;
                }
            }
            return details + ', craftsmanship evident, sensory appeal';
        }

        function buildStoryboard() {
            const container = document.getElementById('storyboardContainer');
            container.innerHTML = '';
            const duration = document.getElementById('reelLength').value === '15' ? 5 : 
                           document.getElementById('reelLength').value === '30' ? 7.5 : 12;
            const sceneNames = ['The Opening', 'The Hook', 'The Heart', 'The Build', 'The Close'];

            appData.shotDetails = [];

            appData.scenes.forEach((scene, i) => {
                const sceneDiv = document.createElement('div');
                sceneDiv.className = 'scene-block';
                
                const title = `Scene ${i + 1}: ${sceneNames[i]}`;
                const shots = extractShotsFromVO(scene.vo, i + 1, appData.heroProduct);
                appData.shotDetails.push(...shots);
                
                let shotsGridHTML = '<div class="shots-grid">';
                shots.forEach(shot => {
                    const timePerShot = Math.round(duration / 5);
                    shotsGridHTML += `
                        <div class="shot-card">
                            <div class="shot-card-number">Shot ${shot.num}</div>
                            <div class="shot-card-label">${shot.label}</div>
                            <div class="shot-card-content">
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">Time</div>
                                    <div class="shot-card-item-value">${(shot.num - 1) * timePerShot}-${shot.num * timePerShot}s</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">What to Shoot</div>
                                    <div class="shot-card-item-value">${shot.extract}</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">Focal Point</div>
                                    <div class="shot-card-item-value">${shot.focal}</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">Where</div>
                                    <div class="shot-card-item-value">${shot.where}</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">Action</div>
                                    <div class="shot-card-item-value">${shot.action}</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">Details</div>
                                    <div class="shot-card-item-value">${shot.details}</div>
                                </div>
                                <div class="shot-card-item">
                                    <div class="shot-card-item-label">B-roll</div>
                                    <div class="shot-card-item-value">${shot.broll}</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                shotsGridHTML += '</div>';
                
                sceneDiv.innerHTML = `
                    <div class="scene-title">${title}</div>
                    <div class="scene-meta">Duration: ${Math.round(duration)}s total | ~${Math.round(duration / 5)}s per shot</div>
                    
                    <div class="scene-section">
                        <div class="scene-section-label">Narrative VO</div>
                        <div class="scene-section-content">${scene.vo}</div>
                    </div>
                    
                    <div class="scene-section">
                        <div class="scene-section-label">Shot Breakdown (Extracted from VO)</div>
                        ${shotsGridHTML}
                    </div>
                `;
                
                container.appendChild(sceneDiv);
            });
        }

        function exportPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'letter');
            const pageWidth = doc.internal.pageSize.getWidth();
            const pageHeight = doc.internal.pageSize.getHeight();
            const marginLeft = 12.7;
            const marginRight = 12.7;
            const marginTop = 12.7;
            const marginBottom = 12.7;
            const colWidth = (pageWidth - marginLeft - marginRight - 6) / 2;
            
            const title = document.getElementById('titleHook').value || 'Storyboard';
            const duration = document.getElementById('reelLength').value === '15' ? 5 : 
                           document.getElementById('reelLength').value === '30' ? 7.5 : 12;
            const sceneNames = ['The Opening', 'The Hook', 'The Heart', 'The Build', 'The Close'];
            const timePerShot = Math.round(duration / 5);

            // Cover Page
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text(title, marginLeft, marginTop + 20, { maxWidth: pageWidth - marginLeft - marginRight });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text('Production-Ready Storyboard', marginLeft, marginTop + 40);
            doc.text('Business: ' + appData.businessName, marginLeft, marginTop + 50);
            doc.text('Hero Product: ' + appData.heroProduct, marginLeft, marginTop + 60);
            doc.text('Date: ' + new Date().toLocaleDateString(), marginLeft, marginTop + 70);

            let y;

            appData.scenes.forEach((scene, sceneIdx) => {
                // New page for each scene
                doc.addPage();
                y = marginTop;

                // Scene title
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                const sceneTitle = 'Scene ' + (sceneIdx + 1) + ': ' + sceneNames[sceneIdx];
                doc.text(sceneTitle, marginLeft, y);
                y += 8;

                // Scene meta
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const metaText = 'Duration: ' + Math.round(duration) + 's total | ~' + timePerShot + 's per shot';
                doc.text(metaText, marginLeft, y);
                y += 8;

                // Narrative VO
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Narrative VO:', marginLeft, y);
                y += 6;
                
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const voLines = doc.splitTextToSize(scene.vo, pageWidth - marginLeft - marginRight);
                doc.text(voLines, marginLeft, y);
                y += (voLines.length * 3.5) + 8;

                // Get shot details for this scene
                const sceneShots = appData.shotDetails.slice(sceneIdx * 5, (sceneIdx + 1) * 5);

                // Shot breakdown header
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('Shot Breakdown (Extracted from VO):', marginLeft, y);
                y += 7;

                // Create 2-column layout with max 12 shots per page
                let shotsOnPage = 0;
                let leftColX = marginLeft;
                let rightColX = marginLeft + colWidth + 6;
                let currentY = y;
                let maxShotsPerCol = 6; // 12 shots total per page (6 per column)

                for (let shotIdx = 0; shotIdx < sceneShots.length; shotIdx++) {
                    const shot = sceneShots[shotIdx];
                    
                    // Check if we need a new page (max 12 shots per page in 2 columns)
                    if (shotsOnPage >= 12) {
                        doc.addPage();
                        currentY = marginTop;
                        shotsOnPage = 0;
                        
                        // Re-add scene header
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.text(sceneTitle + ' (continued)', marginLeft, currentY);
                        currentY += 8;
                    }

                    // Determine which column
                    const isRightCol = shotsOnPage % 2 === 1;
                    const colX = isRightCol ? rightColX : leftColX;
                    const nextColY = isRightCol ? currentY : currentY;
                    
                    // Check if we need to move to next row
                    if (isRightCol && currentY + 35 > pageHeight - marginBottom) {
                        doc.addPage();
                        currentY = marginTop;
                        shotsOnPage = 0;
                        
                        // Re-add scene header
                        doc.setFontSize(10);
                        doc.setFont(undefined, 'bold');
                        doc.text(sceneTitle + ' (continued)', marginLeft, currentY);
                        currentY += 8;
                    }

                    // Draw shot in current column
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'bold');
                    doc.text('Shot ' + shot.num + ': ' + shot.label, colX, currentY);
                    currentY += 4;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(7);
                    doc.text('Time: ' + ((shot.num - 1) * timePerShot) + '-' + (shot.num * timePerShot) + 's', colX + 1, currentY);
                    currentY += 2.5;
                    
                    const whatsToShoot = doc.splitTextToSize(shot.extract, colWidth - 2);
                    doc.text('What: ', colX + 1, currentY);
                    doc.text(whatsToShoot, colX + 6, currentY);
                    currentY += (whatsToShoot.length * 2.5) + 1.5;
                    
                    const focalPoint = doc.splitTextToSize('Focal: ' + shot.focal, colWidth - 2);
                    doc.text(focalPoint, colX + 1, currentY);
                    currentY += (focalPoint.length * 2.5) + 1.5;
                    
                    doc.text('Where: ' + shot.where, colX + 1, currentY);
                    currentY += 2.5;
                    doc.text('Action: ' + shot.action, colX + 1, currentY);
                    currentY += 2.5;
                    
                    const details = doc.splitTextToSize('Details: ' + shot.details, colWidth - 2);
                    doc.text(details, colX + 1, currentY);
                    currentY += (details.length * 2.5) + 1.5;

                    // Move to next column or next row
                    if (!isRightCol) {
                        // Move to right column at same Y
                        currentY = nextColY;
                    } else {
                        // Move to next row, left column
                        currentY += 2;
                    }

                    shotsOnPage++;
                }
            });

            doc.save(appData.businessName.replace(/\s/g, '_') + '_ProductionStoryboard.pdf');
        }

        function editInputs() {
            currentPhase = 1;
            document.querySelectorAll('.phase').forEach(p => p.classList.remove('active'));
            document.getElementById('phase1').classList.add('active');
            updateProgress();
            window.scrollTo(0, 0);
        }

        function loadExample() {
            document.getElementById('businessType').value = 'food';
            document.getElementById('reelObjective').value = 'booking';
            document.getElementById('targetAudience').value = 'hustlers';
            document.getElementById('toneIntensity').value = 'cynical';
            document.getElementById('reelLength').value = '60';
            document.getElementById('heroProduct').value = 'Kufta Burger with fresh lamb';
            document.getElementById('locationSetting').value = 'indoor';
            document.getElementById('businessName').value = 'Jerusalem Grill & Deli';
            document.getElementById('location').value = 'Downtown District';
            document.getElementById('uniqueValue').value = 'Authentic Middle Eastern cuisine made fresh daily with family recipes passed down for generations';
            document.getElementById('specials').value = '$12 kufta burger special after 4pm';
        }
    </script>
</body>
</html>